<!DOCTYPE html>
<html dir="ltr" lang="en-US">
  <head>
  	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  	<title>Writing SimpleRPC Agents — Documentation — Puppet Labs</title>
  	<link rel="alternate" type="application/atom+xml" title="Puppet Labs Documentation Updates" href="https://github.com/puppetlabs/puppet-docs/commits/master.atom">
    <link rel="alternate" type="application/atom+xml" title="Puppet Labs Blog Feed" href="http://puppetlabs.com/feed/atom/">
    <link rel='index' title='Puppet Labs Documentation' href='http://docs.puppetlabs.com' />
    <link rel='icon' href='./../../favicon.ico' />


  <meta name="description" content="Simple RPC works because it makes a lot of assumptions about how you write agents, we&#8217;ll try to capture those assumptions here and show you h...">



    <!-- FIXME: absolute paths -->

    <script type='text/javascript' src='./../../files/javascripts/html5.js'></script>
    <script type='text/javascript' src='./../../files/javascripts/jquery-1.3.2.min.js'></script>
    <script type='text/javascript' src='./../../files/javascripts/drop_down.js'></script>
    <script type='text/javascript' src='./../../files/javascripts/cufon-yui.js'></script>
    <script type='text/javascript' src='./../../files/fonts/Klavika_400-Klavika_600.font.js'></script>
    <script type='text/javascript' src='./../../files/javascripts/ampersands.js'></script>
    <script type='text/javascript' src='./../../files/javascripts/navigation-accordion.js'></script>

    <script type="text/javascript" src="http://puppetlabs.com/wp-content/themes/puppetlabs/javascripts/leadcapture.js"></script>

    <!-- All in One SEO Pack 1.6.10.1 by Michael Torbert of Semper Fi Web Design[127,146] -->
    <meta name="keywords" content="Puppet, puppet labs, reductive labs, open source, system administrator, ruby, data center, automation, support" />
    <!-- /all in one seo pack -->

    <!-- Give us the option of setting a canonical URL in yaml frontmatter -NF -->
    <link rel="canonical" href="http://docs.puppetlabs.com/mcollective/simplerpc/agents.html" />

    <!-- FIXME: absolute paths -->

    <link rel="stylesheet" type="text/css" href="./../../files/stylesheets/style.css" media="screen">
    <link rel="stylesheet" type="text/css" href="./../../files/stylesheets/syntax.css" media="screen"> <!-- index -->
    <link rel="stylesheet" type="text/css" href="./../../files/stylesheets/adbanner.css" media="screen">

    <!--[if IE 7]>
	  <link rel="stylesheet" type="text/css" href="./../../files/stylesheets/ie_7.css" media="screen"> <!-- index -->
    <![endif]-->

    <!--[if IE 8]>
	    <link rel="stylesheet" type="text/css" href="./../../files/stylesheets/ie_8.css" media="screen"> <!-- index -->
    <![endif]-->

  	<script type="text/javascript">
      Cufon.replace('h1, h2', { fontWeight: '600' });
  	</script>
</head>




  <body id="puppetlabsdocs" class="docs">
  <style type="text/css">h1, h2{ visibility : hidden }</style>
  <!--[if IE 8]>
    <style type="text/css">h1, h2{ visibility : visible }</style>
  <![endif]-->

  	<header id="header">
      <div class="site-width">
    		<h1><a href="http://puppetlabs.com/"><span>Puppet Labs</span></a></h1>
        <a class="screen-reader-content" href="#content">Skip navigation</a>
        <nav>
    		<ul id="global-navigation">
          <li id="puppet-tab" class="with-submenu">
            <a href="http://puppetlabs.com/puppet/puppet-enterprise">
              <span>Products</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
			<li>
                <ul>
                   <a href="http://puppetlabs.com/puppet/what-is-puppet/">What is Puppet?</a>
                </ul>
              </li>
			       <li>
                <ul>
                   <a href="http://puppetlabs.com/puppet/puppet-enterprise/">Puppet Enterprise</a>
                </ul>
              </li>
            <li>
                <ul>
                   <a href="http://puppetlabs.com/puppet/whats-new/">What's New in 2.5</a>
                </ul>
              </li>
            <li>
                <ul>
                   <a href="http://puppetlabs.com/puppet/puppet-open-source/">Puppet Open Source</a>
                </ul>
              </li>
            <li>
                <ul>
                   <a href="http://puppetlabs.com/puppet/enterprise-vs-open-source/">Enterprise vs. Open Source</a>
                </ul>
              </li>
              <li>
                <ul>
                  <a href="http://forge.puppetlabs.com">Puppet Forge</a>
                </ul>
              </li>
              <li>
                <ul>
                  <a href="http://puppetlabs.com/puppet/requirements/">Components &amp; Requirements</a>
                </ul>
              </li>
              <li>
                <ul>
                  <a href="http://puppetlabs.com/puppet/faq/">FAQ</a>
                </ul>
              </li>
			  <li>
                <ul>
                  <a href="http://puppetlabs.com/puppet/how-to-buy/">How to Buy</a>
                </ul>
              </li>
            </ul>
          </li>
          <li id="solutions-tab" class="with-submenu">
            <a href="http://puppetlabs.com/solutions/">
              <span>Solutions</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
              <li class="page_item page-item-12296"><a href="http://puppetlabs.com/solutions/configuration-management/">Configuration Management</a></li>
<li class="page_item page-item-986"><a href="http://puppetlabs.com/solutions/virtualization-management/">Virtualization Management</a></li>
<li class="page_item page-item-993"><a href="http://puppetlabs.com/solutions/cloud-management/">Cloud Management</a></li>
<li class="page_item page-item-996"><a href="http://puppetlabs.com/solutions/it-compliance/">IT Compliance</a></li>
<li class="page_item page-item-9520"><a href="http://puppetlabs.com/solutions/devops/">DevOps</a></li>
<li class="page_item page-item-991"><a href="http://puppetlabs.com/solutions/manage-os-x-resources/">OS X Desktops</a></li>
            </ul>
          </li>
          <li id="services-tab" class="with-submenu">
            <a href="http://puppetlabs.com/services/">
              <span>Services</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
              <li class="page_item page-item-783"><a href="http://puppetlabs.com/services/overview/">Overview</a></li>
<li class="page_item page-item-1052"><a href="http://puppetlabs.com/services/customer-support/">Customer Support</a></li>
<li class="page_item page-item-11022"><a href="http://puppetlabs.com/services/support-plans/">Support Plans</a></li>
<li class="page_item page-item-845"><a href="http://puppetlabs.com/services/training-workshops/">On-Site Education</a></li>
<li class="page_item page-item-4899"><a href="http://puppetlabs.com/services/consulting/">Professional Services</a></li>
<li class="page_item page-item-849"><a href="http://puppetlabs.com/category/events/upcoming/">Events &amp; Workshops</a></li>
<li class="page_item page-item-851"><a href="http://puppetlabs.com/services/partners/">Partners</a></li>
            </ul>
          </li>
                    <li id="resources-tab" class="with-submenu">
            <a href="http://puppetlabs.com/resources/">
              <span>Resources</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
              <li class="page_item page-item-1048"><a href="http://puppetlabs.com/resources/overview-2/">Overview</a></li>
<li class="page_item page-item-1040"><a href="http://docs.puppetlabs.com">Documentation</a></li>
<li class="page_item page-item-872"><a href="http://info.puppetlabs.com/register-download">Downloads</a></li>
<li class="page_item page-item-1961"><a href="http://forge.puppetlabs.com">Puppet Forge</a></li>
<li class="page_item page-item-835"><a href="http://info.puppetlabs.com/download-whitepapers.html">White Papers</a></li>
<li class="page_item page-item-1967"><a href="http://projects.puppetlabs.com/projects/puppet/wiki">Wiki</a></li>
<li class="page_item page-item-7279"><a href="http://puppetlabs.com/resources/webinars/">Upcoming Webinars</a></li>
<li class="page_item page-item-10183"><a href="http://puppetlabs.com/resources/newsletter/">Newsletter</a></li>
<li class="page_item page-item-12263"><a href="http://puppetlabs.com/resources/tech-notes/">Tech Notes</a></li>
<li class="page_item page-item-10265"><a href="http://info.puppetlabs.com/pe2-webinar.html">Webinars</a></li>
            </ul>
          </li>

          <li id="customers-tab" class="with-submenu">
            <a href="http://puppetlabs.com/customers/companies/">
              <span>Customers</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
			<li>
                <ul>
                  <a href="http://puppetlabs.com/customers/companies/">Companies</a>
                </ul>
              </li>
			  <li>
                <ul>
                  <a href="http://puppetlabs.com/customers/case-studies/">Case Studies</a>
                </ul>
              </li>
			  <li>
                <ul>
                  <a href="http://puppetlabs.com/customers/product-testimonials/">Product Testimonials</a>
                </ul>
              </li>
			    <li>
                <ul>
                  <a href="http://puppetlabs.com/customers/what-customers-are-saying/">Service Testimonials</a>
                </ul>
              </li>
            </ul>
          </li>
          <li id="community-tab" class="with-submenu">
            <a href="http://puppetlabs.com/community/">
              <span>Community</span>
              <span class="drop-down-trigger"></span>
            </a>

 <ul>
			<li>
                <ul>
                  <a href="http://puppetlabs.com/community/overview/">Overview</a>
                </ul>
              </li>
			<li>
                <ul>
                  <a href="http://puppetlabs.com/blog">Blog</a>
                </ul>
              </li>
			  <li>
                <ul>
                  <a href="http://puppetlabs.com/community/puppet-camp/">Puppet Camp</a>
                </ul>
              </li>
			  <li>
                <ul>
                  <a href="http://puppetlabs.com/community/user-groups-and-devops-groups/">Puppet User Groups & DevOps Groups</a>
                </ul>
              </li>
	          <li>
                <ul>
                  <a href="http://puppetlabs.com/community/presentations/">Presentations</a>
                </ul>
              </li>
			    <li>
                <ul>
                  <a href="http://puppetlabs.com/community/videos/">Videos</a>
                </ul>
              </li>
            </ul>

          <li id="company-tab" class="with-submenu">
            <a href="http://puppetlabs.com/company/">
              <span>Company</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
              <li class="page_item page-item-2316"><a href="http://puppetlabs.com/company/overview/">Overview</a></li>
<li class="page_item page-item-2179"><a href="http://puppetlabs.com/company/news/">News</a>
<ul class='children'>
	<li class="page_item page-item-2338"><a href="http://puppetlabs.com/company/news/press-releases/">Press Releases</a></li>
	<li class="page_item page-item-2383"><a href="http://puppetlabs.com/company/news/media-kit/">Media Kit</a></li>
</ul>
</li>
<li class="page_item page-item-1571"><a href="http://puppetlabs.com/company/careers/">Careers</a></li>
<li class="page_item page-item-10372"><a href="http://puppetlabs.com/company/management/">Management</a></li>
<li class="page_item page-item-10311"><a href="http://puppetlabs.com/company/board-and-advisors/">Board and Advisors</a></li>
<li class="page_item page-item-10367"><a href="http://puppetlabs.com/company/investors/">Investors</a></li>
<li class="page_item page-item-2313"><a href="http://puppetlabs.com/company/contact-us/">Contact Us</a></li>
<li class="page_item page-item-10579"><a href="http://puppetlabs.com/company/awards/">Awards</a></li>
            </ul>
          </li>
    		</ul>
          <div id="misc-navigation">
			  <ul>
				<li><a href="http://puppetlabs.com/security/">Security</a></li>
				<li><a href="http://docs.puppetlabs.com">Documentation</a></li>
				<li><a href="http://puppetlabs.com/resources/customer-support/">Support</a></li>
			        <li><a href="http://projects.puppetlabs.com/">Bug Tracker</a></li>
				<li><a href="http://puppetlabs.com/company/contact/contact-us">Contact Us</a></li>
				<li><a href="http://info.puppetlabs.com/download-pe2.html" class="gateway">Download</a></li>
			  </ul>
			<form action="http://www.google.com/cse" id="cse-search-box">
			  <div>
				<input type="hidden" name="cx" value="017668764424496204839:ubligvgbenm" />
				<input type="hidden" name="ie" value="UTF-8" />
				<input type="text" name="q" class="gsc-input" size="31" />
				<input type="submit" name="sa" class="searchbtn" value="Search" />
			  </div>
			</form>
			<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en"></script>
          </div>
      </nav>
    	</div>
    </header>

      <section id="masthead">
        <div class="site-width">
          <h1>Docs: <span class="section-name">Writing SimpleRPC Agents</span></h1>
          <ul id="doc-navigation">
            <li><a href="./../../index.html">Docs Home</a></li>
            <li class="with-submenu">
              <a href="#">
                <span>Quick Nav</span>
                <span class="drop-down-trigger"></span>
              </a>
               <!-- the following links can't be relative, unfortunately -->
               <!-- future: add some JS to disable this if running from file:// -->
                               <dl>
                  <dt>Puppet Documentation</dt>
                      <dd><a href="./../../puppet/3/reference/index.html">Puppet 3 Reference Manual</a></dd>
                      <dd><a href="./../../puppet/2.7/reference/index.html">Puppet 2.7 Reference Manual</a></dd>
                      <dd><a href="./../../pe/latest/index.html">Puppet Enterprise User's Guide</a></dd>
                      <dd><a href="./../../learning/index.html">Learning Puppet</a></dd>
                      <dd><a href="./../../references/latest/type.html">Resource Types</a></dd>
                      <dd><a href="./../../references/latest/function.html">Functions</a></dd>
                      <dd><a href="./../../references/latest/configuration.html">Configuration</a></dd>
                      <dd><a href="./../../references/latest/developer/index.html">Developer</a></dd>
                      <dd><a href="./../../references/glossary.html">Glossary of Puppet Terms</a></dd>
                      <dd><a href="./../../references/index.html">Older References</a></dd>
                  <dt>Facter</dt>
                      <dd><a href="./../../facter/latest/core_facts.html">Core Facts Reference</a></dd>
                  <dt>PuppetDB</dt>
                      <dd><a href="./../../puppetdb/1/index.html">PuppetDB 1 Manual</a></dd>
                  <dt>MCollective</dt>
                      <dd><a href="./../../mcollective/index.html">Index</a></dd>
                      <dd><a href="./../../mcollective/reference/index.html">References</a></dd>
                      <dd><a href="./../../mcollective/simplerpc/index.html">Writing Plugins</a></dd>
                      <dd><a href="./../../mcollective/releasenotes.html">Release Notes</a></dd>
                </dl>

            </li>
            <li><a href="./../../contribute.html">Contribute</a></li>
          </ul>
        </div>
        <br />
      </section>

      <section id="content">
        <div class="site-width">
          <div class="primary-secondary-content">
            <div class="primary-content">
              <h1>Writing SimpleRPC Agents</h1>
              <nav class="in-page" id="page-nav">
<ol class="toc">
  <li class="toc-lv2"><a href="#conventions-regarding-incoming-data">Conventions regarding Incoming Data</a></li>
  <li class="toc-lv2"><a href="#sample-agent">Sample Agent</a>
<ol class="toc">
   <li class="toc-lv3"><a href="#agent-name">Agent Name</a></li>
   <li class="toc-lv3"><a href="#meta-data-and-initialization">Meta Data and Initialization</a></li>
   <li class="toc-lv3"><a href="#writing-actions">Writing Actions</a></li>
</ol></li>
  <li class="toc-lv2"><a href="#agent-activation">Agent Activation</a></li>
  <li class="toc-lv2"><a href="#help-and-the-data-description-language">Help and the Data Description Language</a></li>
  <li class="toc-lv2"><a href="#validating-input">Validating Input</a></li>
  <li class="toc-lv2"><a href="#agent-configuration">Agent Configuration</a></li>
  <li class="toc-lv2"><a href="#accessing-the-input">Accessing the Input</a></li>
  <li class="toc-lv2"><a href="#running-shell-commands">Running Shell Commands</a></li>
  <li class="toc-lv2"><a href="#constructing-replies">Constructing Replies</a>
<ol class="toc">
   <li class="toc-lv3"><a href="#reply-data">Reply Data</a></li>
   <li class="toc-lv3"><a href="#reply-status">Reply Status</a></li>
</ol></li>
  <li class="toc-lv2"><a href="#actions-in-external-scripts">Actions in external scripts</a></li>
  <li class="toc-lv2"><a href="#sharing-code-between-agents">Sharing code between agents</a></li>
  <li class="toc-lv2"><a href="#authorization">Authorization</a></li>
  <li class="toc-lv2"><a href="#auditing">Auditing</a></li>
  <li class="toc-lv2"><a href="#logging">Logging</a></li>
  <li class="toc-lv2"><a href="#data-caching">Data Caching</a></li>
  <li class="toc-lv2"><a href="#processing-hooks">Processing Hooks</a>
<ol class="toc">
   <li class="toc-lv3"><a href="#startuphook">startup_hook</a></li>
   <li class="toc-lv3"><a href="#beforeprocessinghook">before_processing_hook</a></li>
   <li class="toc-lv3"><a href="#afterprocessinghook">after_processing_hook</a></li>
</ol></li>
</ol></nav>

<p>Simple RPC works because it makes a lot of assumptions about how you write agents, we&#8217;ll try to capture those assumptions here and show you how to apply them to our Helloworld agent.</p>

<p>We&#8217;ve recorded a <a href="http://mcollective.blip.tv/file/3808928/">tutorial that will give you a quick look at what is involved in writing agents</a>.</p>

<h2 id="conventions-regarding-incoming-data">Conventions regarding Incoming Data</h2>

<p>As you&#8217;ve seen in <a href="./../../mcollective/simplerpc/clients.html">SimpleRPCClients</a> our clients will send requests like:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">mc</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="ss">:msg</span> <span class="o">=&gt;</span> <span class="s2">&quot;Welcome to MCollective Simple RPC&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>A more complex example might be:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">exim</span><span class="o">.</span><span class="n">setsender</span><span class="p">(</span><span class="ss">:msgid</span> <span class="o">=&gt;</span> <span class="s2">&quot;1NOTVx-00028U-7G&quot;</span><span class="p">,</span> <span class="ss">:sender</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo@bar.com&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>Effectively this creates a hash with the members <code>:msgid</code> and <code>:sender</code>.</p>

<p>Your data types should be preserved if your Security plugin supports that - the default one does - so you can pass in Arrays, Hashes, OpenStructs, Hashes of Hashes but you should always pass something in and it should be key/value pairs like a Hash expects.</p>

<p>You cannot use the a data item called <code>:process_results</code> as this has special meaning to the agent and client.  This will indicate to the agent that the client is&#8217;nt going to be waiting to process results.  You might choose not to send back a reply based on this.</p>

<h2 id="sample-agent">Sample Agent</h2>
<p>Here&#8217;s our sample <em>Helloworld</em> agent:</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="k">module</span> <span class="nn">MCollective</span>
<span class="lineno"> 2</span>   <span class="k">module</span> <span class="nn">Agent</span>
<span class="lineno"> 3</span>     <span class="k">class</span> <span class="nc">Helloworld</span><span class="o">&lt;</span><span class="no">RPC</span><span class="o">::</span><span class="no">Agent</span>
<span class="lineno"> 4</span>       <span class="c1"># Basic echo server</span>
<span class="lineno"> 5</span>       <span class="n">action</span> <span class="s2">&quot;echo&quot;</span> <span class="k">do</span>
<span class="lineno"> 6</span>         <span class="n">validate</span> <span class="ss">:msg</span><span class="p">,</span> <span class="nb">String</span>
<span class="lineno"> 7</span>
<span class="lineno"> 8</span>         <span class="n">reply</span><span class="o">[</span><span class="ss">:msg</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">[</span><span class="ss">:msg</span><span class="o">]</span>
<span class="lineno"> 9</span>       <span class="k">end</span>
<span class="lineno">10</span>     <span class="k">end</span>
<span class="lineno">11</span>   <span class="k">end</span>
<span class="lineno">12</span> <span class="k">end</span>
</code></pre>
</div>

<p>Strictly speaking this Agent will work but isn&#8217;t considered complete - there&#8217;s no meta data and no help.</p>

<p>A helper agent called <a href="./../../mcollective/reference/plugins/rpcutil.html"><code>rpcutil</code></a> is included that helps you gather stats, inventory etc about the running daemon.  It&#8217;s a full SimpleRPC agent including DDL, you can look at it for an example.</p>

<h3 id="agent-name">Agent Name</h3>
<p>The agent name is derived from the class name, the example code creates <em>MCollective::Agent::Helloworld</em> and the agent name would be <em>helloworld</em>.</p>

<p><a name="Meta_Data_and_Initialization">&nbsp;</a></p>

<h3 id="meta-data-and-initialization">Meta Data and Initialization</h3>
<p>Simple RPC agents still need meta data like in <a href="./../../mcollective/reference/basic/basic_agent_and_client.html">WritingAgents</a>, without it you&#8217;ll just have some defaults assigned, code below adds the meta data to our agent:</p>

<p><strong>NOTE</strong>: As of version 2.1.1 the <code>metadata</code> section is deprecated, all agents must have DDL files with this information in them.</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="k">module</span> <span class="nn">MCollective</span>
<span class="lineno"> 2</span>   <span class="k">module</span> <span class="nn">Agent</span>
<span class="lineno"> 3</span>     <span class="k">class</span> <span class="nc">Helloworld</span><span class="o">&lt;</span><span class="no">RPC</span><span class="o">::</span><span class="no">Agent</span>
<span class="lineno"> 4</span>       <span class="n">metadata</span> <span class="ss">:name</span>        <span class="o">=&gt;</span> <span class="s2">&quot;helloworld&quot;</span><span class="p">,</span>
<span class="lineno"> 5</span>                <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;Echo service for MCollective&quot;</span><span class="p">,</span>
<span class="lineno"> 6</span>                <span class="ss">:author</span>      <span class="o">=&gt;</span> <span class="s2">&quot;R.I.Pienaar&quot;</span><span class="p">,</span>
<span class="lineno"> 7</span>                <span class="ss">:license</span>     <span class="o">=&gt;</span> <span class="s2">&quot;GPLv2&quot;</span><span class="p">,</span>
<span class="lineno"> 8</span>                <span class="ss">:version</span>     <span class="o">=&gt;</span> <span class="s2">&quot;1.1&quot;</span><span class="p">,</span>
<span class="lineno"> 9</span>                <span class="ss">:url</span>         <span class="o">=&gt;</span> <span class="s2">&quot;http://projects.puppetlabs.com/projects/mcollective-plugins/wiki&quot;</span><span class="p">,</span>
<span class="lineno">10</span>                <span class="ss">:timeout</span>     <span class="o">=&gt;</span> <span class="mi">60</span>
<span class="lineno">11</span>
<span class="lineno">12</span>       <span class="c1"># Basic echo server</span>
<span class="lineno">13</span>       <span class="n">action</span> <span class="s2">&quot;echo&quot;</span> <span class="k">do</span>
<span class="lineno">14</span>         <span class="n">validate</span> <span class="ss">:msg</span><span class="p">,</span> <span class="nb">String</span>
<span class="lineno">15</span>
<span class="lineno">16</span>         <span class="n">reply</span><span class="o">[</span><span class="ss">:msg</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">[</span><span class="ss">:msg</span><span class="o">]</span>
<span class="lineno">17</span>       <span class="k">end</span>
<span class="lineno">18</span>     <span class="k">end</span>
<span class="lineno">19</span>   <span class="k">end</span>
<span class="lineno">20</span> <span class="k">end</span>
</code></pre>
</div>

<p>The added code sets our creator info, license and version as well as a timeout.  The timeout is how long MCollective will let your agent run for before killing them, this is a very important number and should be given careful consideration.  If you set it too low your agents will be terminated before their work is done.</p>

<p>The default timeout for SimpleRPC agents is <em>10</em>.</p>

<h3 id="writing-actions">Writing Actions</h3>
<p>Actions are the individual tasks that your agent can do:</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno">1</span> <span class="n">action</span> <span class="s2">&quot;echo&quot;</span> <span class="k">do</span>
<span class="lineno">2</span>   <span class="n">validate</span> <span class="ss">:msg</span><span class="p">,</span> <span class="nb">String</span>
<span class="lineno">3</span>
<span class="lineno">4</span>   <span class="n">reply</span><span class="o">[</span><span class="ss">:msg</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">[</span><span class="ss">:msg</span><span class="o">]</span>
<span class="lineno">5</span> <span class="k">end</span>
</code></pre>
</div>

<p>Creates an action called &#8220;echo&#8221;.  They don&#8217;t and can&#8217;t take any arguments.</p>

<h2 id="agent-activation">Agent Activation</h2>
<p>In the past you had to copy an agent only to machines that they should be running on as
all agents were activated regardless of dependencies.</p>

<p>To make deployment simpler agents support the ability to determine if they should run
on a particular platform.  By default SimpleRPC agents can be configured to activate
or not:</p>

<div class="highlight"><pre><code class="ini"><span class="na">plugin.helloworld.activate_agent</span> <span class="o">=</span> <span class="s">false</span>
</code></pre>
</div>

<p>You can also place the following in <code>/etc/mcollective/plugins.d/helloworld.cfg</code>:</p>

<div class="highlight"><pre><code class="ini"><span class="na">activate_agent</span> <span class="o">=</span> <span class="s">false</span>
</code></pre>
</div>

<p>This is a simple way to enable or disable an agent on your machine, agents can also
declare their own logic that will get called each time an agent gets loaded from disk.</p>

<div class="highlight"><pre><code class="ruby"><span class="k">module</span> <span class="nn">MCollective</span>
  <span class="k">module</span> <span class="nn">Agent</span>
    <span class="k">class</span> <span class="nc">Helloworld</span><span class="o">&lt;</span><span class="no">RPC</span><span class="o">::</span><span class="no">Agent</span>

      <span class="n">activate_when</span> <span class="k">do</span>
        <span class="no">File</span><span class="o">.</span><span class="n">executable?</span><span class="p">(</span><span class="s2">&quot;/usr/bin/puppet&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>If this block returns false or raises an exception then the agent will not be active on
this machine and it will not be discovered.</p>

<p>When the agent gets loaded it will test if <code>/usr/bin/puppet</code> exist and only if it does
will this agent be enabled.</p>

<h2 id="help-and-the-data-description-language">Help and the Data Description Language</h2>
<p>We have a separate file that goes together with an agent and is used to describe the agent in detail, a DDL file for the above echo agent can be seen below:</p>

<p><strong>NOTE</strong>: As of version 2.1.1 the DDL files are required to be on the the nodes before an agent will be activated</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="n">metadata</span> <span class="ss">:name</span>        <span class="o">=&gt;</span> <span class="s2">&quot;echo&quot;</span><span class="p">,</span>
<span class="lineno"> 2</span>          <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;Echo service for MCollective&quot;</span><span class="p">,</span>
<span class="lineno"> 3</span>          <span class="ss">:author</span>      <span class="o">=&gt;</span> <span class="s2">&quot;R.I.Pienaar&quot;</span><span class="p">,</span>
<span class="lineno"> 4</span>          <span class="ss">:license</span>     <span class="o">=&gt;</span> <span class="s2">&quot;GPLv2&quot;</span><span class="p">,</span>
<span class="lineno"> 5</span>          <span class="ss">:version</span>     <span class="o">=&gt;</span> <span class="s2">&quot;1.1&quot;</span><span class="p">,</span>
<span class="lineno"> 6</span>          <span class="ss">:url</span>         <span class="o">=&gt;</span> <span class="s2">&quot;http://projects.puppetlabs.com/projects/mcollective-plugins/wiki&quot;</span><span class="p">,</span>
<span class="lineno"> 7</span>          <span class="ss">:timeout</span>     <span class="o">=&gt;</span> <span class="mi">60</span>
<span class="lineno"> 8</span>
<span class="lineno"> 9</span> <span class="n">action</span> <span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;Echos back any message it receives&quot;</span> <span class="k">do</span>
<span class="lineno">10</span>    <span class="n">input</span> <span class="ss">:msg</span><span class="p">,</span>
<span class="lineno">11</span>          <span class="ss">:prompt</span>      <span class="o">=&gt;</span> <span class="s2">&quot;Service Name&quot;</span><span class="p">,</span>
<span class="lineno">12</span>          <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;The service to get the status for&quot;</span><span class="p">,</span>
<span class="lineno">13</span>          <span class="ss">:type</span>        <span class="o">=&gt;</span> <span class="ss">:string</span><span class="p">,</span>
<span class="lineno">14</span>          <span class="ss">:validation</span>  <span class="o">=&gt;</span> <span class="s1">&#39;^[a-zA-Z\-_\d]+$&#39;</span><span class="p">,</span>
<span class="lineno">15</span>          <span class="ss">:optional</span>    <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
<span class="lineno">16</span>          <span class="ss">:maxlength</span>   <span class="o">=&gt;</span> <span class="mi">30</span>
<span class="lineno">17</span>
<span class="lineno">18</span>    <span class="n">output</span> <span class="ss">:msg</span><span class="p">,</span>
<span class="lineno">19</span>           <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;The message we received&quot;</span><span class="p">,</span>
<span class="lineno">20</span>           <span class="ss">:display_as</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Message&quot;</span>
<span class="lineno">21</span> <span class="k">end</span>
</code></pre>
</div>

<p>As you can see the DDL file expand on the basic syntax adding a lot of markup, help and other important validation data.  This information - when available - helps in making more robust clients and also potentially auto generating user interfaces.</p>

<p>The DDL is a complex topic, read all about it in <a href="./../../mcollective/reference/plugins/ddl.html">DDL</a>.</p>

<h2 id="validating-input">Validating Input</h2>
<p>If you&#8217;ve followed the conventions and put the incoming data in a Hash structure then you can use a few of the provided validators to make sure your data that you received is what you expected.</p>

<p>If you didn&#8217;t use Hashes for input the validators would not be usable to you.  In future validation will happen automatically based on the <a href="./../../mcollective/reference/plugins/ddl.html">DDL</a> so I strongly suggest you follow the agent design pattern shown here using hashes.</p>

<p>In the sample action above we validate the <em>:msg</em> input to be of type <em>String</em>, here are a few more examples:</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno">1</span>    <span class="n">validate</span> <span class="ss">:msg</span><span class="p">,</span> <span class="sr">/[a-zA-Z]+/</span>
<span class="lineno">2</span>    <span class="n">validate</span> <span class="ss">:ipaddr</span><span class="p">,</span> <span class="ss">:ipv4address</span>
<span class="lineno">3</span>    <span class="n">validate</span> <span class="ss">:ipaddr</span><span class="p">,</span> <span class="ss">:ipv6address</span>
<span class="lineno">4</span>    <span class="n">validate</span> <span class="ss">:commmand</span><span class="p">,</span> <span class="ss">:shellsafe</span>
<span class="lineno">5</span>    <span class="n">validate</span> <span class="ss">:mode</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;packages&quot;</span><span class="o">]</span>
</code></pre>
</div>

<p>The table below shows the validators we support currently</p>

<table>
  <thead>
    <tr>
      <th>Type of Check</th>
      <th>Description</th>
      <th>Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Regular Expressions</td>
      <td>Matches the input against the supplied regular expression</td>
      <td>validate :msg, /[a-zA-Z]+/</td>
    </tr>
    <tr>
      <td>Type Checks</td>
      <td>Verifies that input is of a given ruby data type</td>
      <td>validate :msg, String</td>
    </tr>
    <tr>
      <td>IPv4 Checks</td>
      <td>Validates an ip v4 address, note 5.5.5.5 is technically a valid address</td>
      <td>validate :ipaddr, :ipv4address</td>
    </tr>
    <tr>
      <td>IPv6 Checks</td>
      <td>Validates an ip v6 address</td>
      <td>validate :ipaddr, :ipv6address</td>
    </tr>
    <tr>
      <td>system call safety checks</td>
      <td>Makes sure the input is a string and has no &gt;&lt;backtick, semi colon, dollar, ambersand or pipe characters in it</td>
      <td>validate :command, :shellsafe</td>
    </tr>
    <tr>
      <td>Boolean</td>
      <td>Ensures a input value is either real boolean true or false</td>
      <td>validate :enable, :bool</td>
    </tr>
    <tr>
      <td>List of valid options</td>
      <td>Ensures the input data is one of a list of known good values</td>
      <td>validate :mode, [&#8220;all&#8221;, &#8220;packages&#8221;]</td>
    </tr>
  </tbody>
</table>

<p>All of these checks will raise an InvalidRPCData exception, you shouldn&#8217;t catch this exception as the Simple RPC framework catches those and handles them appropriately.</p>

<p>We&#8217;ll make input validators plugins so you can provide your own types of validation easily.</p>

<p>Additionally if can escape strings being passed to a shell, escaping is done in line with the <code>Shellwords#shellescape</code> method that is in newer version of Ruby:</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno">1</span>    <span class="n">safe</span> <span class="o">=</span> <span class="n">shellescape</span><span class="p">(</span><span class="n">request</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span><span class="p">)</span>
</code></pre>
</div>

<p>As of version 2.2.0 you can add your own types of validation using <a href="./../../mcollective/reference/plugins/validator.html">Validator Plugins</a>.</p>

<h2 id="agent-configuration">Agent Configuration</h2>

<p>You can save configuration for your agents in the main server config file:</p>

<div class="highlight"><pre><code class="ini"> <span class="na">plugin.helloworld.setting</span> <span class="o">=</span> <span class="s">foo</span>
</code></pre>
</div>

<p>In your code you can retrieve the config setting like this:</p>

<div class="highlight"><pre><code class="ini"> <span class="na">setting</span> <span class="o">=</span> <span class="s">config.pluginconf[&quot;helloworld.setting&quot;] || &quot;&quot;</span>
</code></pre>
</div>

<p>This will set the setting to whatever is the config file of &#8220;&#8221; if unset.</p>

<h2 id="accessing-the-input">Accessing the Input</h2>
<p>As you see from the echo example our input is easy to get to by just looking in <em>request</em>, this would be a Hash of exactly what was sent in by the client in the original request.</p>

<p>The request object is in instance of <em>MCollective::RPC::Request</em>, you can also gain access to the following:</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>time</td>
      <td>The time the message was sent</td>
    </tr>
    <tr>
      <td>action</td>
      <td>The action it is directed at</td>
    </tr>
    <tr>
      <td>data</td>
      <td>The actual hash of data</td>
    </tr>
    <tr>
      <td>sender</td>
      <td>The id of the sender</td>
    </tr>
    <tr>
      <td>agent</td>
      <td>Which agent it was directed at</td>
    </tr>
  </tbody>
</table>

<p>Since data is the actual Hash you can gain access to your input like:</p>

<div class="highlight"><pre><code class="ruby"> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">[</span><span class="ss">:msg</span><span class="o">]</span>
</code></pre>
</div>

<p>OR</p>

<div class="highlight"><pre><code class="ruby"><span class="n">request</span><span class="o">[</span><span class="ss">:msg</span><span class="o">]</span>
</code></pre>
</div>

<p>Accessing it via the first will give you full access to all the normal Hash methods where the 2nd will only give you access to <em>include?</em>.</p>

<h2 id="running-shell-commands">Running Shell Commands</h2>

<p>A helper function exist that makes it easier to run shell commands and gain
access to their <code>STDOUT</code> and <code>STDERR</code>.</p>

<p>We recommend everyone use this method for calling to shell commands as it forces
<code>LC_ALL</code> to <code>C</code> as well as wait on all the children and avoids zombies, you can
set unique working directories and shell environments that would be impossible
using simple <code>system</code> that is provided with Ruby.</p>

<p>The simplest case is just to run a command and send output back to the client:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo &#39;hello world&#39;&quot;</span><span class="p">,</span> <span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:out</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:err</span><span class="p">)</span>
</code></pre>
</div>

<p>Here you will have set <code>reply[:out]</code>, <code>reply[:err]</code> and <code>reply[:status]</code> based
on the output from the command.</p>

<p>You can append the output of the command to any string:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">out</span> <span class="o">=</span> <span class="o">[]</span>
<span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo &#39;hello world&#39;&quot;</span><span class="p">,</span> <span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="n">out</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="n">err</span><span class="p">)</span>
</code></pre>
</div>

<p>Here the STDOUT of the command will be saved in the variable <code>out</code> and not sent
back to the caller.  The only caveat is that the variables <code>out</code> and <code>err</code> should
have the <code>&lt;&lt;</code> method, so if you supplied an array each line of output will be a
single member of the array.  In the example <code>out</code> would be an array of lines
while <code>err</code> would just be a big multi line string.</p>

<p>By default any trailing new lines will be included in the output and error:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo &#39;hello world&#39;&quot;</span><span class="p">,</span> <span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:out</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:err</span><span class="p">)</span>
<span class="n">reply</span><span class="o">[</span><span class="ss">:stdout</span><span class="o">].</span><span class="n">chomp!</span>
<span class="n">reply</span><span class="o">[</span><span class="ss">:stderr</span><span class="o">].</span><span class="n">chomp!</span>
</code></pre>
</div>

<p>You can shorten this to:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo &#39;hello world&#39;&quot;</span><span class="p">,</span> <span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:out</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:err</span><span class="p">,</span> <span class="ss">:chomp</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</code></pre>
</div>

<p>This will remove a trailing new line from the <code>reply[:out]</code> and <code>reply[:err]</code>.</p>

<p>If you wanted this command to run from the <code>/tmp</code> directory:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo &#39;hello world&#39;&quot;</span><span class="p">,</span> <span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:out</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:err</span><span class="p">,</span> <span class="ss">:cwd</span> <span class="o">=&gt;</span> <span class="s2">&quot;/tmp&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>Or if you wanted to include a shell Environment variable:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo &#39;hello world&#39;&quot;</span><span class="p">,</span> <span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:out</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:err</span><span class="p">,</span> <span class="ss">:environment</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s2">&quot;FOO&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;BAR&quot;</span><span class="p">})</span>
</code></pre>
</div>

<p>The status returned will be the exit code from the program you ran, if the program
completely failed to run in the case where the file doesn&#8217;t exist, resources were
not available etc the exit code will be -1</p>

<p>You have to set the cwd and environment through these options, do not simply
call <code>chdir</code> or adjust the <code>ENV</code> hash in an agent as that will not be safe in
the context of a multi threaded Ruby application.</p>

<h2 id="constructing-replies">Constructing Replies</h2>

<h3 id="reply-data">Reply Data</h3>
<p>The reply data is in the <em>reply</em> variable and is an instance of <em>MCollective::RPC::Reply</em>.</p>

<div class="highlight"><pre><code class="ruby"><span class="n">reply</span><span class="o">[</span><span class="ss">:msg</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">[</span><span class="ss">:msg</span><span class="o">]</span>
</code></pre>
</div>

<h3 id="reply-status">Reply Status</h3>
<p>As pointed out in the <a href="./../../mcollective/simplerpc/clients.html#Results_and_Exceptions">ResultsandExceptions</a> page results all include status messages and the reply object has a helper to create those.</p>

<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">rmmsg_action</span>
  <span class="n">validate</span> <span class="ss">:msg</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">validate</span> <span class="ss">:msg</span><span class="p">,</span> <span class="sr">/[a-zA-Z]+-[a-zA-Z]+-[a-zA-Z]+-[a-zA-Z]+/</span>
  <span class="n">reply</span><span class="o">.</span><span class="n">fail</span> <span class="s2">&quot;No such message </span><span class="si">#{</span><span class="n">request</span><span class="o">[</span><span class="ss">:msg</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="k">unless</span> <span class="n">have_msg?</span><span class="p">(</span><span class="n">request</span><span class="o">[</span><span class="ss">:msg</span><span class="o">]</span><span class="p">)</span>

  <span class="c1"># check all the validation passed before doing any work</span>
  <span class="k">return</span> <span class="k">unless</span> <span class="n">reply</span><span class="o">.</span><span class="n">statuscode</span> <span class="o">==</span> <span class="mi">0</span>

  <span class="c1"># now remove the message from the queue</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The number in <code>reply.fail</code> corresponds to the codes in <a href="./../../mcollective/simplerpc/clients.html#Results_and_Exceptions">ResultsandExceptions</a> it would default to <code>1</code> so you could just say:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">reply</span><span class="o">.</span><span class="n">fail</span> <span class="s2">&quot;No such message </span><span class="si">#{</span><span class="n">request</span><span class="o">[</span><span class="ss">:msg</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">unless</span> <span class="n">have_msg?</span><span class="p">(</span><span class="n">request</span><span class="o">[</span><span class="ss">:msg</span><span class="o">]</span><span class="p">)</span>
</code></pre>
</div>

<p>This is hypothetical action that is supposed to remove a message from some queue, if we do have a String as input that matches our message id&#8217;s we then check that we do have such a message and if we don&#8217;t we fail with a helpful message.</p>

<p>Technically this will just set <code>statuscode</code> and <code>statusmsg</code> fields in the reply to appropriate values.</p>

<p>It won&#8217;t actually raise exceptions or exit your action though you should do that yourself as in the example here.</p>

<p>There is also a <code>fail!</code> instead of just <code>fail</code> it does the same basic function but also raises exceptions.  This lets you abort processing of the agent immediately without performing your own checks on <code>statuscode</code> as above later on.</p>

<h2 id="actions-in-external-scripts">Actions in external scripts</h2>
<p>Actions can be implemented using other programming languages as long as they support JSON.</p>

<div class="highlight"><pre><code class="ruby"><span class="n">action</span> <span class="s2">&quot;test&quot;</span> <span class="k">do</span>
  <span class="n">implemented_by</span> <span class="s2">&quot;/some/external/script&quot;</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The script <code>/some/external/script</code> will be called with 2 arguments:</p>

<ul>
  <li>The path to a file with the request in JSON format</li>
  <li>The path to a file where you should write your response as a JSON hash</li>
</ul>

<p>You can also access these 2 file paths in the <code>MCOLLECTIVE_REPLY_FILE</code> and <code>MCOLLECTIVE_REQUEST_FILE</code> environment variables</p>

<p>Simply write your reply as a JSON hash into the reply file.</p>

<p>The exit code of your script should correspond to the ones in <a href="./../../mcollective/simplerpc/clients.html#Results_and_Exceptions">ResultsandExceptions</a>.  Any text in STDERR will be
logged on the server at <code>error</code> level and used in the text for the fail text.</p>

<p>Any text to STDOUT will be logged on the server at level <code>info</code>.</p>

<p>These scripts can be placed in a standard location:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">action</span> <span class="s2">&quot;test&quot;</span> <span class="k">do</span>
  <span class="n">implemented_by</span> <span class="s2">&quot;script.py&quot;</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This will search each configured libdir for <code>libdir/agent/agent_name/script.py</code>. If you specified a full path it will not try to find the file in libdirs.</p>

<h2 id="sharing-code-between-agents">Sharing code between agents</h2>
<p>Sometimes you have code that is needed by multiple agents or shared between the agent and client.  MCollective has
name space called <code>MCollective::Util</code> for this kind of code and the packagers and so forth supports it.</p>

<p>Create a class with your shared code given a name like <code>MCollective::Util::Yourco</code> and save this file in the libdir in <code>util/yourco.rb</code></p>

<p>A sample class can be seen here:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">module</span> <span class="nn">MCollective</span>
  <span class="k">module</span> <span class="nn">Util</span>
    <span class="k">class</span> <span class="nc">Yourco</span>
      <span class="k">def</span> <span class="nf">dosomething</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>You can now use it in your agent or clients by first loading it from the MCollective lib directories:</p>

<div class="highlight"><pre><code class="ruby"><span class="no">MCollective</span><span class="o">::</span><span class="no">Util</span><span class="o">.</span><span class="n">loadclass</span><span class="p">(</span><span class="s2">&quot;MCollective::Util::Yourco&quot;</span><span class="p">)</span>

<span class="n">helpers</span> <span class="o">=</span> <span class="no">MCollective</span><span class="o">::</span><span class="no">Util</span><span class="o">::</span><span class="no">Yourco</span><span class="o">.</span><span class="n">new</span>
<span class="n">helpers</span><span class="o">.</span><span class="n">dosomething</span>
</code></pre>
</div>

<h2 id="authorization">Authorization</h2>
<p>You can write a fine grained Authorization system to control access to actions and agents, please see <a href="./../../mcollective/simplerpc/authorization.html">SimpleRPCAuthorization</a> for full details.</p>

<h2 id="auditing">Auditing</h2>
<p>The actions that agents perform can be Audited by code you provide, potentially creating a centralized audit log of all actions.  See <a href="./../../mcollective/simplerpc/auditing.html">SimpleRPCAuditing</a> for full details.</p>

<h2 id="logging">Logging</h2>
<p>You can write to the server log file using the normal logger class:</p>

<div class="highlight"><pre><code class="ruby"><span class="no">Log</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s2">&quot;Hello from your agent&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>You can log at levels <code>info</code>, <code>warn</code>, <code>debug</code>, <code>fatal</code> or <code>error</code>.</p>

<h2 id="data-caching">Data Caching</h2>
<p>As of version 2.2.0 there is a system wide Cache you can use to store data that might be costly to create on each request.</p>

<p>The Cache is thread safe and can be used even with multiple concurrent requests for the same agent.</p>

<p>Imagine your agent interacts with a customer database on the node that is slow to read data from but this data does not
change often. Using the cache you can arrange for this be read only every 10 minutes:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">action</span> <span class="s2">&quot;get_customer_data&quot;</span> <span class="k">do</span>
  <span class="c1"># Create a new cache called &#39;customer&#39; with a 600 second TTL,</span>
  <span class="c1"># noop if it already exist</span>
  <span class="no">Cache</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="ss">:customer</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>

  <span class="k">begin</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="no">Cache</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="ss">:customer</span><span class="p">,</span> <span class="n">request</span><span class="o">[</span><span class="ss">:customerid</span><span class="o">]</span><span class="p">)</span>
  <span class="k">rescue</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="no">Cache</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="ss">:customer</span><span class="p">,</span> <span class="n">request</span><span class="o">[</span><span class="ss">:customerid</span><span class="o">]</span><span class="p">,</span> <span class="n">get_customer</span><span class="p">(</span><span class="n">request</span><span class="o">[</span><span class="ss">:customerid</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># do something with the customer data</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Here we setup a new cache table called <code>:customer</code> if it does not already exist, the cache has a 10 minute validity.
We then try to read a cached customer record for <code>request[:customerid]</code> and if it&#8217;s not been put in the cache
before or if it expired I create a new customer record using a method called <code>get_customer</code> and then save it
into the cache.</p>

<p>If you have critical code in an agent that can only ever be run once you can use the Mutex from the same cache
to synchronize the code:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">action</span> <span class="s2">&quot;get_customer_data&quot;</span> <span class="k">do</span>
  <span class="c1"># Create a new cache called &#39;customer&#39; with a 600 second TTL,</span>
  <span class="c1"># noop if it already exist</span>
  <span class="no">Cache</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="ss">:customer</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>

  <span class="no">Cache</span><span class="p">(</span><span class="ss">:customer</span><span class="p">)</span><span class="o">.</span><span class="n">synchronize</span> <span class="k">do</span>
     <span class="c1"># Update customer record</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Here we are using the same Cache that was previously setup and just gaining access to the Mutex protecting the
cache data.  The code inside the synchronize block will only be run once so you won&#8217;t get competing updates to
your customer data.</p>

<p>If the lock is held too long by anyone the mcollectived will kill the threads in line with the Agent timeout.</p>

<h2 id="processing-hooks">Processing Hooks</h2>
<p>We provide a few hooks into the processing of a message, you&#8217;ve already used this earlier to <a href="#Meta_Data_and_Initialization">set meta data</a>.</p>

<p>You&#8217;d use these hooks to add some functionality into the processing chain of agents, maybe you want to add extra logging for audit purposes of the raw incoming message and replies, these hooks will let you do that.</p>

<table>
  <thead>
    <tr>
      <th>Hook Function Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>startup_hook</code></td>
      <td>Called at the end of the initialize method of the <code>RPC::Agent</code> base class</td>
    </tr>
    <tr>
      <td><code>before_processing_hook(msg, connection)</code></td>
      <td>Before processing of a message starts, pass in the raw message and the <code>MCollective::Connector</code> class</td>
    </tr>
    <tr>
      <td><code>after_processing_hook</code></td>
      <td>Just before the message is dispatched to the client</td>
    </tr>
  </tbody>
</table>

<h3 id="startuphook"><code>startup_hook</code></h3>
<p>Called at the end of the <code>RPC::Agent</code> standard initialize method use this to adjust meta parameters, timeouts and any setup you need to do.</p>

<p>This will not be called right when the daemon starts up, we use lazy loading and initialization so it will only be called the first time a request for this agent arrives.</p>

<h3 id="beforeprocessinghook"><code>before_processing_hook</code></h3>
<p>Called just after a message was received from the middleware before it gets passed to the handlers.  <code>request</code> and <code>reply</code> will already be set, the msg passed is the message as received from the normal mcollective runner and the connection is the actual connector.</p>

<p>You can in theory send off new messages over the connector maybe for auditing or something, probably limited use case in simple agents.</p>

<h3 id="afterprocessinghook"><code>after_processing_hook</code></h3>
<p>Called at the end of processing just before the response gets sent to the middleware.</p>

<p>This gets run outside of the main exception handling block of the agent so you should handle any exceptions you could raise yourself.  The reason  it is outside of the block is so you&#8217;ll have access to even status codes set by the exception handlers.  If you do raise an exception it will just be passed onto the runner and processing will fail.</p>

              <blockquote><p style="font-size: 1.3em; text-align: center;"><a href="#content">↑ Back to top</a></p></blockquote>
            </div>
            <nav class="main">
                  <div id="subCol">


<ul>
  <li><strong>Overview</strong>
    <ul>
      <li><a href="./../../mcollective/index.html">Introduction</a></li>
      <li><a href="./../../mcollective/overview_components.html">Overview of Components</a></li>
      <li><a href="./../../mcollective/terminology.html">Terminology</a></li>
      <li><a href="./../../mcollective/screencasts.html">Screencasts</a></li>
      <li><a href="./../../mcollective/releasenotes.html">Release Notes</a></li>
      <li><a href="./../../mcollective/changelog.html">Changelog</a></li>
    </ul>
  </li>
  <li><strong>Deploying MCollective</strong>
    <ul>
      <li><a href="./../../mcollective/deploy/index.html">Index</a></li>
      <li><a href="./../../mcollective/deploy/demo.html">Demo</a></li>
      <li><a href="./../../mcollective/deploy/standard.html">Getting Started (Standard Deployment)</a></li>
    </ul>
  </li>
  <li><strong>Configuration / Deployment Topics</strong>
    <ul>
      <li><strong>Installation:</strong></li>
      <li><a href="./../../mcollective/deploy/install.html">Installing MCollective</a></li>
      <li><a href="./../../mcollective/deploy/plugins.html">Installing Plugins</a></li>
      <li><strong>Configuration:</strong></li>
      <li><a href="./../../mcollective/configure/server.html">Server Config Reference</a></li>
      <li><a href="./../../mcollective/configure/client.html">Client Config Reference</a></li>
      <li><a href="./../../mcollective/reference/integration/puppet.html">Puppet Integration</a></li>
      <li><a href="./../../mcollective/reference/integration/chef.html">Chef Integration</a></li>
      <li><strong>Middleware:</strong></li>
      <li><a href="./../../mcollective/deploy/middleware/index.html">Middleware Types</a></li>
      <li><a href="./../../mcollective/deploy/middleware/activemq.html">ActiveMQ Configs for MCollective</a></li>
      <li><a href="./../../mcollective/deploy/middleware/activemq_keystores.html">ActiveMQ TLS Keystore Setup</a></li>
      <li><a href="./../../mcollective/reference/integration/activemq_clusters.html">ActiveMQ Clustering</a></li>
      <li><a href="./../../mcollective/reference/integration/activemq_ssl.html">ActiveMQ TLS</a></li>
      <li><a href="./../../mcollective/reference/integration/activemq_security.html">ActiveMQ Security</a></li>
      <li><strong>Connector Plugins:</strong></li>
      <li><a href="./../../mcollective/reference/plugins/connector_activemq.html">The ActiveMQ Connector</a></li>
      <li><a href="./../../mcollective/reference/plugins/connector_rabbitmq.html">The RabbitMQ Connector</a></li>
      <li><strong>Security Plugins:</strong></li>
      <li><a href="./../../mcollective/reference/plugins/security_ssl.html">Configuring SSL Validation Security</a></li>
      <li><strong>Advanced Features:</strong></li>
      <li><a href="./../../mcollective/reference/basic/subcollectives.html">Subcollectives and Partitioning</a></li>
      <li><a href="./../../mcollective/simplerpc/auditing.html">Auditing</a> <!-- contains plugin-writing info --></li>
    </ul>
  </li>
  <li><strong>Use and Administer MCollective</strong>
    <ul>
      <li><a href="./../../mcollective/reference/basic/basic_cli_usage.html">Command Line Usage Instructions</a></li>
      <li><a href="./../../mcollective/reference/ui/filters.html">Command Filtering and Discovery</a></li>
      <li><a href="./../../mcollective/reference/basic/daemon.html">Controlling the MCollective Daemon</a></li>
      <li><a href="./../../mcollective/reference/plugins/rpcutil.html">Controlling the MCollective Daemon with the rpcutil Agent</a></li>
      <li><a href="./../../mcollective/reference/ui/nodereports.html">On-Demand Node Reports</a></li>
    </ul>
  </li>
  <li><strong>Write Agent Plugins</strong>
    <ul>
      <li><span class="currentpage">Writing Agent Plugins</span></li>
      <li><a href="./../../mcollective/reference/plugins/ddl.html">Writing DDL Files</a></li>
      <li><a href="./../../mcollective/reference/plugins/aggregate.html">Aggregating Results</a> <!-- mixes DDL info with info about writing aggregate plugins --></li>
    </ul>
  </li>
  <li><strong>Write Clients and Applications</strong>
    <ul>
      <li><a href="./../../mcollective/simplerpc/clients.html">Writing Clients</a></li>
      <li><a href="./../../mcollective/reference/plugins/application.html">Writing New mco Subcommands</a></li>
    </ul>
  </li>
  <li><strong>Write Other Plugins</strong>
    <ul>
      <li><a href="./../../mcollective/simplerpc/authorization.html">Writing Authorization Plugins and Enabling Authorization</a> <!-- contains deploy/config info --></li>
      <li><a href="./../../mcollective/reference/plugins/data.html">Writing Data Plugins</a></li>
      <li><a href="./../../mcollective/reference/plugins/discovery.html">Writing and Using Discovery Plugins</a> <!-- contains usage info --></li>
      <li><a href="./../../mcollective/reference/plugins/facts.html">Writing Facts Plugins</a></li>
      <li><a href="./../../mcollective/reference/plugins/registration.html">Writing Registration Plugins</a></li>
      <li><a href="./../../mcollective/reference/plugins/validator.html">Writing Validator Plugins</a></li>
    </ul>
  </li>
  <li><a href="http://projects.puppetlabs.com/projects/mcollective-plugins/wiki">Plugin Directory</a></li>
  <li><strong>Internals</strong>
    <ul>
      <li><a href="./../../mcollective/reference/basic/messageflow.html">Message Flow</a> <!-- needs more/needs update --></li>
      <li><a href="./../../mcollective/simplerpc/index.html">SimpleRPC Overview</a></li>
      <li><a href="./../../mcollective/simplerpc/messageformat.html">SimpleRPC Message Format</a></li>
      <li><a href="./../../mcollective/reference/basic/messageformat.html">Core Message Format</a></li>
      <li><a href="./../../mcollective/security.html">Security Overview</a></li>
    </ul>
  </li>
  <li><strong>Older and Non-Recommended Information</strong>
    <ul>
      <li><a href="./../../mcollective/reference/plugins/security_aes.html">Configuring AES Security</a></li>
      <li><a href="./../../mcollective/reference/plugins/connector_stomp.html">Configuring the Generic Stomp Connector</a></li>
      <li><a href="./../../mcollective/reference/basic/basic_agent_and_client.html">Writing Old-Style Agent Plugins</a></li>
      <li><a href="./../../mcollective/reference/index.html">Alternate Index</a></li>
    </ul>
  </li>
</ul>

                      <div style="margin-top: 1.5em; padding-bottom: 10px;">
                          <p style="font-family: 'Lucida Grande',Lucida,Verdana,sans-serif;font-size: 16px; font-weight: bold; line-height: 22px; margin-bottom: 10px;">Download the Docs</p>
                          <a href="http://info.puppetlabs.com/download-pdfs.html"><img src="./../../images/smallbits_small_docs.png" alt="Puppet docs download"></a>
                      </div>
                      <div style="margin-top: 0; padding-bottom: 10px;">
                          <p style="font-family: 'Lucida Grande',Lucida,Verdana,sans-serif;font-size: 16px; font-weight: bold; line-height: 22px; margin-bottom: 10px;">Download Puppet Enterprise</p>
                          <a href="http://info.puppetlabs.com/download-pe.html"><img src="./../../images/puppet_cert_home.jpg" alt="Puppet Enterprise promo"></a>
                      </div>
                  </div>
            </nav>
          </div>
        </div>
      </section>

		<footer id="footer">
      <div class="site-width">

        <div class="primary-secondary-content">
          <div class="primary-content">
            <section id="newsletter">
                 <h4>Puppet Labs is Hiring</h4>
                 <p><a href="http://www.puppetlabs.com/company/jobs/">Engineers, developers & consultants</a>
                  <p>
		<h4>Newsletter</h4>

              <p>Stay up to date on all things puppet</p>

				<form class="lpeRegForm formNotEmpty" method="post" enctype="application/x-www-form-urlencoded" action="http://info.puppetlabs.com/index.php/leadCapture/save"; id="mktForm_1013" name="mktForm_1013">

				<label>Email Address:</label><span class='mktInput'><input class='mktFormText mktFormEmail' name="Email" id="Email" type='text' value="" maxlength='255'  /><span class='mktFormMsg'></span></span>

				<input id='mktFrmSubmit' type='submit' class='btn' style="width: auto; overflow: visible; padding-left: .25em; padding-right: .25em;" value='Subscribe' name='submitButton' onclick='formSubmit(document.getElementById("mktForm_1013")); return false;' />

				<input style='display: none;' id='mktFrmReset' type='reset' value='Clear' name='resetButton' onclick='formReset(document.getElementById("mktForm_1013")); return false;' />

				<span style="display:none;"><input type="text" name="_marketo_comments" value="" /></span>
				<input type="hidden" name="lpId" value="-1" />
				<input type="hidden" name="subId" value="100" />

				<input type="hidden" name="kw" value="" />
				<input type="hidden" name="cr" value="" />

				<input type="hidden" name="searchstr" value="" />
				<input type="hidden" name="lpurl" value="http://info.puppetlabs.com/testsubscription.html?cr={creative}&kw={keyword}"; />
				<input type="hidden" name="formid" value="1013" />
				<input type="hidden" name="returnURL" value="http://www.puppetlabs.com/misc/subscription-thank-you/"; />
				<input type="hidden" name="retURL" value="http://www.puppetlabs.com/misc/subscription-thank-you/"; />
				<input type="hidden" name="_mkt_disp" value="return" />
				<input type="hidden" name="_mkt_trk" value="" />

				</form>
				<script type="text/javascript" src="http://info.puppetlabs.com/js/mktFormSupport.js"></script>

				<script type="text/javascript">
				function formSubmit(elt) {
				return Mkto.formSubmit(elt);
				}
				function formReset(elt) {
				return Mkto.formReset(elt);
				}
				</script>

<a href="http://info.puppetlabs.com/puppet-enterprise" class="fbtn">Try Puppet Enterprise FREE</a>

            </section>
            <section id="elsewhere">
              <h4>Get Involved</h4>
              <ul>

                <li class="chat"><a href="http://webchat.freenode.net/?channels=puppet" rel="external"><span class="indicator"></span><span>Chat with us on IRC</span></a></li>
		<li class="discussion"><a href="http://groups.google.com/group/puppet-dev" rel="external"><span class="indicator"></span><span>Join the Puppet Developer List</span></a></li>
                <li class="discussion"><a href="http://groups.google.com/group/puppet-users?pli=1" rel="external"><span class="indicator"></span><span>Join the Puppet User List</span></a></li>

                <li class="linkedin"><a href="http://www.linkedin.com/groups?about=&gid=696467&trk=anet_ug_grppro" rel="external"><span class="indicator"></span><span>Join the Puppet Users LinkedIn group</span></a></li>

              </ul>
		<p>
		              		<h4>Follow us&#8230;</h4>

              		<ul class="followus">


			<li><a href="http://feeds.feedburner.com/PuppetLabs" target="_blank"><img src="http://www.puppetlabs.com/wp-content/plugins/my-profiles/images/rss.png" border="0"></a></li>
			<li><a href="http://www.facebook.com/pages/Puppet-Labs/219089920711" target="_blank"><img src="http://www.puppetlabs.com//wp-content/plugins/my-profiles/images/facebook.png" border="0"></a></li>
			<li><a href="http://www.twitter.com/puppetlabs" target="_blank"><img src="http://www.puppetlabs.com//wp-content/plugins/my-profiles/images/twitter.png" border="0"></a></li>
			<li><a href="http://www.linkedin.com/groups?about=&amp;gid=696467&amp;trk=anet_ug_grppro" target="_blank"><img src="http://www.puppetlabs.com//wp-content/uploads/2011/01/LinkedIn_IN_Icon_32px.png" border="0"></a></li>    <li><a href="https://github.com/puppetlabs" target="_blank"><img src="http://www.puppetlabs.com//wp-content/uploads/2011/01/github_icon.png" border="0"></a></li>
			<li><a href="https://plus.google.com/112682055028218091774?rel=author" target="_blank"><img src="https://puppetlabs.com/wp-content/uploads/2013/05/google_plus32x32.png" alt="Find Us on Google+" border="0"></a></li>
					</ul>

              	</p>

            </section>
          </div>
          <div class="secondary-content">
            <section id="book-it">
              <h4>Get the book!</h4>

              <p>James Turnbull and Jeff McCune's book <a href="http://www.apress.com/9781430230571" rel="nofollow">Pro Puppet</a> is a comprehensive and up-to-date look at Puppet and MCollective. </p>
              <a href="http://www.apress.com/9781430230571" rel="nofollow"><img src="http://www.puppetlabs.com/wp-content/uploads/2011/05/propuppetthumb.png" /></a>
            </section>
          </div>
        </div>
      </div>
		</footer>

    <div id="copyright">
      <div class="site-width">
        &copy; 2011 <a href="http://www.puppetlabs.com/" title="Puppet Labs">Puppet Labs</a>
        <span class="vcard">
         <span class="org"></span>
         <a class="email" href="mailto:info@puppetlabs.com">info@puppetlabs.com</a>

          <span class="adr">
           <span class="street-address">926 NW 13th Avenue #210</span>
           /
           <span class="locality">Portland</span>,
           <span class="region">OR</span>
           <span class="postal-code">97209</span>

          </span>

         <span class="tel">1-877-575-9775</span>
        </span>
      </div>
    </div>

  	<script type="text/javascript">Cufon.now();</script>
  	<style type="text/css">h1, h2, .btn { visibility : visible; }</style>


	</body>
</html>
