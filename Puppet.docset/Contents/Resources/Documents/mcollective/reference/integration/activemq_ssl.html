<!DOCTYPE html>
<html dir="ltr" lang="en-US">
  <head>
  	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  	<title>ActiveMQ TLS — Documentation — Puppet Labs</title>
  	<link rel="alternate" type="application/atom+xml" title="Puppet Labs Documentation Updates" href="https://github.com/puppetlabs/puppet-docs/commits/master.atom">
    <link rel="alternate" type="application/atom+xml" title="Puppet Labs Blog Feed" href="http://puppetlabs.com/feed/atom/">
    <link rel='index' title='Puppet Labs Documentation' href='http://docs.puppetlabs.com' />
    <link rel='icon' href='./../../../favicon.ico' />


  <meta name="description" content="You can configure MCollective and ActiveMQ to do end-to-end encryption over TLS. This allows you to use MCollective&#8217;s fast and efficient SSL ...">



    <!-- FIXME: absolute paths -->

    <script type='text/javascript' src='./../../../files/javascripts/html5.js'></script>
    <script type='text/javascript' src='./../../../files/javascripts/jquery-1.3.2.min.js'></script>
    <script type='text/javascript' src='./../../../files/javascripts/drop_down.js'></script>
    <script type='text/javascript' src='./../../../files/javascripts/cufon-yui.js'></script>
    <script type='text/javascript' src='./../../../files/fonts/Klavika_400-Klavika_600.font.js'></script>
    <script type='text/javascript' src='./../../../files/javascripts/ampersands.js'></script>
    <script type='text/javascript' src='./../../../files/javascripts/navigation-accordion.js'></script>

    <script type="text/javascript" src="http://puppetlabs.com/wp-content/themes/puppetlabs/javascripts/leadcapture.js"></script>

    <!-- All in One SEO Pack 1.6.10.1 by Michael Torbert of Semper Fi Web Design[127,146] -->
    <meta name="keywords" content="Puppet, puppet labs, reductive labs, open source, system administrator, ruby, data center, automation, support" />
    <!-- /all in one seo pack -->

    <!-- Give us the option of setting a canonical URL in yaml frontmatter -NF -->
    <link rel="canonical" href="http://docs.puppetlabs.com/mcollective/reference/integration/activemq_ssl.html" />

    <!-- FIXME: absolute paths -->

    <link rel="stylesheet" type="text/css" href="./../../../files/stylesheets/style.css" media="screen">
    <link rel="stylesheet" type="text/css" href="./../../../files/stylesheets/syntax.css" media="screen"> <!-- index -->
    <link rel="stylesheet" type="text/css" href="./../../../files/stylesheets/adbanner.css" media="screen">

    <!--[if IE 7]>
	  <link rel="stylesheet" type="text/css" href="./../../../files/stylesheets/ie_7.css" media="screen"> <!-- index -->
    <![endif]-->

    <!--[if IE 8]>
	    <link rel="stylesheet" type="text/css" href="./../../../files/stylesheets/ie_8.css" media="screen"> <!-- index -->
    <![endif]-->

  	<script type="text/javascript">
      Cufon.replace('h1, h2', { fontWeight: '600' });
  	</script>
</head>




  <body id="puppetlabsdocs" class="docs">
  <style type="text/css">h1, h2{ visibility : hidden }</style>
  <!--[if IE 8]>
    <style type="text/css">h1, h2{ visibility : visible }</style>
  <![endif]-->

  	<header id="header">
      <div class="site-width">
    		<h1><a href="http://puppetlabs.com/"><span>Puppet Labs</span></a></h1>
        <a class="screen-reader-content" href="#content">Skip navigation</a>
        <nav>
    		<ul id="global-navigation">
          <li id="puppet-tab" class="with-submenu">
            <a href="http://puppetlabs.com/puppet/puppet-enterprise">
              <span>Products</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
			<li>
                <ul>
                   <a href="http://puppetlabs.com/puppet/what-is-puppet/">What is Puppet?</a>
                </ul>
              </li>
			       <li>
                <ul>
                   <a href="http://puppetlabs.com/puppet/puppet-enterprise/">Puppet Enterprise</a>
                </ul>
              </li>
            <li>
                <ul>
                   <a href="http://puppetlabs.com/puppet/whats-new/">What's New in 2.5</a>
                </ul>
              </li>
            <li>
                <ul>
                   <a href="http://puppetlabs.com/puppet/puppet-open-source/">Puppet Open Source</a>
                </ul>
              </li>
            <li>
                <ul>
                   <a href="http://puppetlabs.com/puppet/enterprise-vs-open-source/">Enterprise vs. Open Source</a>
                </ul>
              </li>
              <li>
                <ul>
                  <a href="http://forge.puppetlabs.com">Puppet Forge</a>
                </ul>
              </li>
              <li>
                <ul>
                  <a href="http://puppetlabs.com/puppet/requirements/">Components &amp; Requirements</a>
                </ul>
              </li>
              <li>
                <ul>
                  <a href="http://puppetlabs.com/puppet/faq/">FAQ</a>
                </ul>
              </li>
			  <li>
                <ul>
                  <a href="http://puppetlabs.com/puppet/how-to-buy/">How to Buy</a>
                </ul>
              </li>
            </ul>
          </li>
          <li id="solutions-tab" class="with-submenu">
            <a href="http://puppetlabs.com/solutions/">
              <span>Solutions</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
              <li class="page_item page-item-12296"><a href="http://puppetlabs.com/solutions/configuration-management/">Configuration Management</a></li>
<li class="page_item page-item-986"><a href="http://puppetlabs.com/solutions/virtualization-management/">Virtualization Management</a></li>
<li class="page_item page-item-993"><a href="http://puppetlabs.com/solutions/cloud-management/">Cloud Management</a></li>
<li class="page_item page-item-996"><a href="http://puppetlabs.com/solutions/it-compliance/">IT Compliance</a></li>
<li class="page_item page-item-9520"><a href="http://puppetlabs.com/solutions/devops/">DevOps</a></li>
<li class="page_item page-item-991"><a href="http://puppetlabs.com/solutions/manage-os-x-resources/">OS X Desktops</a></li>
            </ul>
          </li>
          <li id="services-tab" class="with-submenu">
            <a href="http://puppetlabs.com/services/">
              <span>Services</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
              <li class="page_item page-item-783"><a href="http://puppetlabs.com/services/overview/">Overview</a></li>
<li class="page_item page-item-1052"><a href="http://puppetlabs.com/services/customer-support/">Customer Support</a></li>
<li class="page_item page-item-11022"><a href="http://puppetlabs.com/services/support-plans/">Support Plans</a></li>
<li class="page_item page-item-845"><a href="http://puppetlabs.com/services/training-workshops/">On-Site Education</a></li>
<li class="page_item page-item-4899"><a href="http://puppetlabs.com/services/consulting/">Professional Services</a></li>
<li class="page_item page-item-849"><a href="http://puppetlabs.com/category/events/upcoming/">Events &amp; Workshops</a></li>
<li class="page_item page-item-851"><a href="http://puppetlabs.com/services/partners/">Partners</a></li>
            </ul>
          </li>
                    <li id="resources-tab" class="with-submenu">
            <a href="http://puppetlabs.com/resources/">
              <span>Resources</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
              <li class="page_item page-item-1048"><a href="http://puppetlabs.com/resources/overview-2/">Overview</a></li>
<li class="page_item page-item-1040"><a href="http://docs.puppetlabs.com">Documentation</a></li>
<li class="page_item page-item-872"><a href="http://info.puppetlabs.com/register-download">Downloads</a></li>
<li class="page_item page-item-1961"><a href="http://forge.puppetlabs.com">Puppet Forge</a></li>
<li class="page_item page-item-835"><a href="http://info.puppetlabs.com/download-whitepapers.html">White Papers</a></li>
<li class="page_item page-item-1967"><a href="http://projects.puppetlabs.com/projects/puppet/wiki">Wiki</a></li>
<li class="page_item page-item-7279"><a href="http://puppetlabs.com/resources/webinars/">Upcoming Webinars</a></li>
<li class="page_item page-item-10183"><a href="http://puppetlabs.com/resources/newsletter/">Newsletter</a></li>
<li class="page_item page-item-12263"><a href="http://puppetlabs.com/resources/tech-notes/">Tech Notes</a></li>
<li class="page_item page-item-10265"><a href="http://info.puppetlabs.com/pe2-webinar.html">Webinars</a></li>
            </ul>
          </li>

          <li id="customers-tab" class="with-submenu">
            <a href="http://puppetlabs.com/customers/companies/">
              <span>Customers</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
			<li>
                <ul>
                  <a href="http://puppetlabs.com/customers/companies/">Companies</a>
                </ul>
              </li>
			  <li>
                <ul>
                  <a href="http://puppetlabs.com/customers/case-studies/">Case Studies</a>
                </ul>
              </li>
			  <li>
                <ul>
                  <a href="http://puppetlabs.com/customers/product-testimonials/">Product Testimonials</a>
                </ul>
              </li>
			    <li>
                <ul>
                  <a href="http://puppetlabs.com/customers/what-customers-are-saying/">Service Testimonials</a>
                </ul>
              </li>
            </ul>
          </li>
          <li id="community-tab" class="with-submenu">
            <a href="http://puppetlabs.com/community/">
              <span>Community</span>
              <span class="drop-down-trigger"></span>
            </a>

 <ul>
			<li>
                <ul>
                  <a href="http://puppetlabs.com/community/overview/">Overview</a>
                </ul>
              </li>
			<li>
                <ul>
                  <a href="http://puppetlabs.com/blog">Blog</a>
                </ul>
              </li>
			  <li>
                <ul>
                  <a href="http://puppetlabs.com/community/puppet-camp/">Puppet Camp</a>
                </ul>
              </li>
			  <li>
                <ul>
                  <a href="http://puppetlabs.com/community/user-groups-and-devops-groups/">Puppet User Groups & DevOps Groups</a>
                </ul>
              </li>
	          <li>
                <ul>
                  <a href="http://puppetlabs.com/community/presentations/">Presentations</a>
                </ul>
              </li>
			    <li>
                <ul>
                  <a href="http://puppetlabs.com/community/videos/">Videos</a>
                </ul>
              </li>
            </ul>

          <li id="company-tab" class="with-submenu">
            <a href="http://puppetlabs.com/company/">
              <span>Company</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
              <li class="page_item page-item-2316"><a href="http://puppetlabs.com/company/overview/">Overview</a></li>
<li class="page_item page-item-2179"><a href="http://puppetlabs.com/company/news/">News</a>
<ul class='children'>
	<li class="page_item page-item-2338"><a href="http://puppetlabs.com/company/news/press-releases/">Press Releases</a></li>
	<li class="page_item page-item-2383"><a href="http://puppetlabs.com/company/news/media-kit/">Media Kit</a></li>
</ul>
</li>
<li class="page_item page-item-1571"><a href="http://puppetlabs.com/company/careers/">Careers</a></li>
<li class="page_item page-item-10372"><a href="http://puppetlabs.com/company/management/">Management</a></li>
<li class="page_item page-item-10311"><a href="http://puppetlabs.com/company/board-and-advisors/">Board and Advisors</a></li>
<li class="page_item page-item-10367"><a href="http://puppetlabs.com/company/investors/">Investors</a></li>
<li class="page_item page-item-2313"><a href="http://puppetlabs.com/company/contact-us/">Contact Us</a></li>
<li class="page_item page-item-10579"><a href="http://puppetlabs.com/company/awards/">Awards</a></li>
            </ul>
          </li>
    		</ul>
          <div id="misc-navigation">
			  <ul>
				<li><a href="http://puppetlabs.com/security/">Security</a></li>
				<li><a href="http://docs.puppetlabs.com">Documentation</a></li>
				<li><a href="http://puppetlabs.com/resources/customer-support/">Support</a></li>
			        <li><a href="http://projects.puppetlabs.com/">Bug Tracker</a></li>
				<li><a href="http://puppetlabs.com/company/contact/contact-us">Contact Us</a></li>
				<li><a href="http://info.puppetlabs.com/download-pe2.html" class="gateway">Download</a></li>
			  </ul>
			<form action="http://www.google.com/cse" id="cse-search-box">
			  <div>
				<input type="hidden" name="cx" value="017668764424496204839:ubligvgbenm" />
				<input type="hidden" name="ie" value="UTF-8" />
				<input type="text" name="q" class="gsc-input" size="31" />
				<input type="submit" name="sa" class="searchbtn" value="Search" />
			  </div>
			</form>
			<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en"></script>
          </div>
      </nav>
    	</div>
    </header>

      <section id="masthead">
        <div class="site-width">
          <h1>Docs: <span class="section-name">ActiveMQ TLS</span></h1>
          <ul id="doc-navigation">
            <li><a href="./../../../index.html">Docs Home</a></li>
            <li class="with-submenu">
              <a href="#">
                <span>Quick Nav</span>
                <span class="drop-down-trigger"></span>
              </a>
               <!-- the following links can't be relative, unfortunately -->
               <!-- future: add some JS to disable this if running from file:// -->
                               <dl>
                  <dt>Puppet Documentation</dt>
                      <dd><a href="./../../../puppet/3/reference/index.html">Puppet 3 Reference Manual</a></dd>
                      <dd><a href="./../../../puppet/2.7/reference/index.html">Puppet 2.7 Reference Manual</a></dd>
                      <dd><a href="./../../../pe/latest/index.html">Puppet Enterprise User's Guide</a></dd>
                      <dd><a href="./../../../learning/index.html">Learning Puppet</a></dd>
                      <dd><a href="./../../../references/latest/type.html">Resource Types</a></dd>
                      <dd><a href="./../../../references/latest/function.html">Functions</a></dd>
                      <dd><a href="./../../../references/latest/configuration.html">Configuration</a></dd>
                      <dd><a href="./../../../references/latest/developer/index.html">Developer</a></dd>
                      <dd><a href="./../../../references/glossary.html">Glossary of Puppet Terms</a></dd>
                      <dd><a href="./../../../references/index.html">Older References</a></dd>
                  <dt>Facter</dt>
                      <dd><a href="./../../../facter/latest/core_facts.html">Core Facts Reference</a></dd>
                  <dt>PuppetDB</dt>
                      <dd><a href="./../../../puppetdb/1/index.html">PuppetDB 1 Manual</a></dd>
                  <dt>MCollective</dt>
                      <dd><a href="./../../../mcollective/index.html">Index</a></dd>
                      <dd><a href="./../../../mcollective/reference/index.html">References</a></dd>
                      <dd><a href="./../../../mcollective/simplerpc/index.html">Writing Plugins</a></dd>
                      <dd><a href="./../../../mcollective/releasenotes.html">Release Notes</a></dd>
                </dl>

            </li>
            <li><a href="./../../../contribute.html">Contribute</a></li>
          </ul>
        </div>
        <br />
      </section>

      <section id="content">
        <div class="site-width">
          <div class="primary-secondary-content">
            <div class="primary-content">
              <h1>ActiveMQ TLS</h1>


<p>You can configure MCollective and ActiveMQ to do end-to-end encryption over TLS. This allows you to use MCollective&#8217;s fast and efficient <a href="./../../../mcollective/reference/plugins/security_ssl.html">SSL security plugin</a> instead of the slow and hard to configure <a href="/mcollective/reference/plugins/security_aes.html">AES security plugin</a>. </p>

<p>There are two main approaches:</p>

<ul>
  <li><a href="#ca-verified-tls">CA-verified TLS</a> encrypts traffic, and also lets you restrict middleware connections &#8212; only nodes with valid certificates from the site&#8217;s CA can connect.</li>
  <li><a href="#anonymous-tls">Anonymous TLS</a> encrypts messages to prevent casual traffic sniffing, and will prevent the passwords MCollective uses to connect to ActiveMQ from being stolen. However, it doesn&#8217;t check whether nodes are allowed to connect, so you have to trust your username and password security.</li>
</ul>

<p>This feature requires:</p>

<ul>
  <li>MCollective 2.0.0 or newer</li>
  <li>ActiveMQ 5.5.0 or newer</li>
  <li>Stomp gem 1.2.2 or newer</li>
  <li>The <a href="./../../../mcollective/reference/plugins/connector_activemq.html">activemq connector</a> plugin (included with MCollective 2.0.0 and newer)</li>
</ul>

<h2 id="ca-verified-tls">CA-Verified TLS</h2>

<p><strong>(Recommended For Most Users)</strong></p>

<h3 id="summary">Summary</h3>

<p>This approach configures MCollective and ActiveMQ to only accept connections when the peer has a certificate signed by the site&#8217;s CA. </p>

<p><strong>Benefits:</strong></p>

<p>This approach gives extra security, and your MCollective servers will generally already have the credentials they need since you can re-use Puppet certificates.</p>

<p><strong>Drawbacks:</strong></p>

<p>You will need to go out of your way to issue keys and certificates to your admin users, which is an extra step when onboarding a new admin.</p>

<h3 id="step-1-configure-activemq-to-use-tls">Step 1: Configure ActiveMQ to Use TLS</h3>

<p>Do the following steps to get ActiveMQ configured:</p>

<ul>
  <li>Follow <a href="./../../../mcollective/deploy/middleware/activemq_keystores.html">the ActiveMQ keystores guide</a> to create Java keystores for ActiveMQ.</li>
  <li><a href="./../../../mcollective/deploy/middleware/activemq.html#tls-credentials">Configure activemq.xml&#8217;s <code>&lt;sslContext&gt;</code> element to point at the keystores.</a></li>
  <li><a href="./../../../mcollective/deploy/middleware/activemq.html#transport-connectors">Configure the proper URIs in the broker&#8217;s transport connectors.</a></li>
  <li>Restart ActiveMQ.</li>
</ul>

<p>At this point, MCollective servers and clients should be unable to connect to ActiveMQ, since they do not yet have credentials configured.</p>

<h3 id="step-2-configure-mcollective-servers">Step 2: Configure MCollective Servers</h3>

<p>For the MCollective daemon you can use your existing Puppet certificates by editing the <em>server.cfg</em> file:</p>

<div class="highlight"><pre><code class="ini"><span class="na">connector</span> <span class="o">=</span> <span class="s">activemq</span>
<span class="c"># Optional:</span>
<span class="c"># plugin.activemq.base64 = yes</span>
<span class="na">plugin.activemq.pool.size</span> <span class="o">=</span> <span class="s">1</span>
<span class="na">plugin.activemq.pool.1.host</span> <span class="o">=</span> <span class="s">stomp.example.com</span>
<span class="na">plugin.activemq.pool.1.port</span> <span class="o">=</span> <span class="s">61614</span>
<span class="na">plugin.activemq.pool.1.user</span> <span class="o">=</span> <span class="s">mcollective</span>
<span class="na">plugin.activemq.pool.1.password</span> <span class="o">=</span> <span class="s">secret</span>
<span class="na">plugin.activemq.pool.1.ssl</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">plugin.activemq.pool.1.ssl.ca</span> <span class="o">=</span> <span class="s">/var/lib/puppet/ssl/ca/ca_crt.pem</span>
<span class="na">plugin.activemq.pool.1.ssl.key</span> <span class="o">=</span> <span class="s">/var/lib/puppet/ssl/private_keys/&lt;NAME&gt;.pem</span>
<span class="na">plugin.activemq.pool.1.ssl.cert</span> <span class="o">=</span> <span class="s">/var/lib/puppet/ssl/certs/&lt;NAME&gt;.pem</span>
</code></pre>
</div>

<ul>
  <li>Set the correct paths to each node&#8217;s private key and certificate; they will be named after the node&#8217;s Puppet certname and located in the ssldir.
    <ul>
      <li>You can locate a node&#8217;s private key by running <code>sudo puppet agent --configprint hostprivkey</code>, the certificate with <code>sudo puppet agent --configprint hostcert</code>, and the CA certificate with <code>sudo puppet agent --configprint localcacert</code>.</li>
    </ul>
  </li>
  <li>Set the correct username and password.</li>
</ul>

<h3 id="step-3-configure-mcollective-clients">Step 3: Configure MCollective Clients</h3>

<p>Each client will now need a TLS certificate issued by the Puppet CA in order to be able to
connect to the ActiveMQ:</p>

<div class="highlight"><pre><code class="bash"><span class="c"># puppet cert generate ripienaar</span>
notice: ripienaar has a waiting certificate request
notice: Signed certificate request <span class="k">for </span>ripienaar
notice: Removing file Puppet::SSL::CertificateRequest ripienaar at <span class="s1">&#39;/var/lib/puppet/ssl/ca/requests/ripienaar.pem&#39;</span>
notice: Removing file Puppet::SSL::CertificateRequest ripienaar at <span class="s1">&#39;/var/lib/puppet/ssl/certificate_requests/ripienaar.pem&#39;</span>
</code></pre>
</div>

<p>Copy the certificates to your user:</p>

<div class="highlight"><pre><code class="bash"><span class="c"># mkdir /home/rip/.mcollective.d</span>
<span class="c"># cp /var/lib/puppet/ssl/ca/ca_crt.pem /home/rip/.mcollective.d/</span>
<span class="c"># cp /var/lib/puppet/ssl/private_keys/ripienaar.pem /home/rip/.mcollective.d/ripienaar-private.pem</span>
<span class="c"># cp /var/lib/puppet/ssl/public_keys/ripienaar.pem /home/rip/.mcollective.d/ripienaar.pem</span>
<span class="c"># cp /var/lib/puppet/ssl/certs/ripienaar.pem /home/rip/.mcollective.d/ripienaar-cert.pem</span>
<span class="c"># chown -R rip:rip /home/rip/.mcollective.d</span>
</code></pre>
</div>

<p>You can now configure the mcollective client config in <em>/home/rip/.mcollective</em> to use these:</p>

<div class="highlight"><pre><code class="ini"><span class="na">connector</span> <span class="o">=</span> <span class="s">activemq</span>
<span class="c"># Optional:</span>
<span class="c"># plugin.activemq.base64 = yes</span>
<span class="na">plugin.activemq.pool.size</span> <span class="o">=</span> <span class="s">1</span>
<span class="na">plugin.activemq.pool.1.host</span> <span class="o">=</span> <span class="s">stomp.example.com</span>
<span class="na">plugin.activemq.pool.1.port</span> <span class="o">=</span> <span class="s">61614</span>
<span class="na">plugin.activemq.pool.1.user</span> <span class="o">=</span> <span class="s">ripienaar</span>
<span class="na">plugin.activemq.pool.1.password</span> <span class="o">=</span> <span class="s">secret</span>
<span class="na">plugin.activemq.pool.1.ssl</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">plugin.activemq.pool.1.ssl.ca</span> <span class="o">=</span> <span class="s">/home/rip/.mcollective.d/ca_crt.pem</span>
<span class="na">plugin.activemq.pool.1.ssl.key</span> <span class="o">=</span> <span class="s">/home/rip/.mcollective.d/ripienaar-private.pem</span>
<span class="na">plugin.activemq.pool.1.ssl.cert</span> <span class="o">=</span> <span class="s">/home/rip/.mcollective.d/ripienaar-cert.pem</span>
</code></pre>
</div>

<p>If you are using the SSL security plugin, you can use these same files by setting <code>/home/rip/.mcollective.d/ripienaar.pem</code> as the public key.</p>

<h3 id="finish-verify-encryption">Finish: Verify Encryption</h3>

<p>If you want to be sure of this, you should now verify with tcpdump or wireshark that the connection and traffic
really is all encrypted.</p>

<h3 id="troubleshooting-common-errors">Troubleshooting Common Errors</h3>

<p>You will get some obvious errors from this code if any files are missing, but the errors from SSL validation will be pretty
hard to understand.</p>

<p>There are two main scenarios where ActiveMQ will reject an MCollective conneciton:</p>

<h4 id="mcollective-uses-wrong-ca-to-verify-activemq-cert">MCollective Uses Wrong CA to Verify ActiveMQ Cert</h4>

<p>When the client connects using a CA set in <em>plugin.activemq.pool.1.ssl.ca</em> that does not match the one
in the ActiveMQ <em>truststore.jks</em>:</p>

<div class="highlight"><pre><code class="console"><span class="go">failed: SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed</span>
</code></pre>
</div>

<p>And in the ActiveMQ log:</p>

<div class="highlight"><pre><code class="console"><span class="go">Transport failed: javax.net.ssl.SSLHandshakeException: Received fatal alert: unknown_ca</span>
</code></pre>
</div>

<h4 id="mcollective-certs-arent-signed-by-the-right-ca">MCollective Certs Aren&#8217;t Signed by the Right CA</h4>

<p>When your client has the correct CA but his certificates are not signed by that CA:</p>

<div class="highlight"><pre><code class="console"><span class="go">failed: SSL_connect returned=1 errno=0 state=SSLv3 read finished A: sslv3 alert certificate unknown</span>
</code></pre>
</div>

<p>And in the ActiveMQ log:</p>

<div class="highlight"><pre><code class="console"><span class="go">sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target</span>
</code></pre>
</div>

<h2 id="anonymous-tls">Anonymous TLS</h2>

<p><strong>(Less Recommended)</strong></p>

<h3 id="summary-1">Summary</h3>

<p>This approach configures MCollective and ActiveMQ to encrypt traffic via TLS, but accept connections from anyone.</p>

<p><strong>Benefits:</strong></p>

<p>This approach requires less configuration, especially when adding new admin users.</p>

<p><strong>Drawbacks:</strong></p>

<p>This approach has some relative security drawbacks. Depending on your site&#8217;s security needs, these may not concern you &#8212; since MCollective&#8217;s application-level security plugins will prevent an attacker from issuing agent commands and owning your servers, attacks like those below would only result in denial of service plus some leakage of inventory data via lower-level discovery protocols.</p>

<ul>
  <li>Although attackers can&#8217;t sniff MCollective&#8217;s ActiveMQ passwords, there&#8217;s nothing to prevent them from logging in if they steal a password through some other means. (With CA-verified TLS, on the other hand, they would also require a private key and certificate, which provides some additional security depth.)</li>
  <li>An attacker able to run a man-in-the-middle attack at your site could fool your MCollective servers into trusting a malicious ActiveMQ server. </li>
</ul>

<h3 id="step-1-configure-activemq-to-use-anonymous-tls">Step 1: Configure ActiveMQ to Use Anonymous TLS</h3>

<ul>
  <li>Follow <a href="./../../../mcollective/deploy/middleware/activemq_keystores.html">the ActiveMQ keystores guide</a> to create a Java keystore for ActiveMQ. <em>You can skip the truststore.</em> </li>
  <li><a href="./../../../mcollective/deploy/middleware/activemq.html#tls-credentials">Configure activemq.xml&#8217;s <code>&lt;sslContext&gt;</code> element to point at the keystore.</a> <em>You can skip the <code>trustStore</code> and <code>trustStorePassword</code> attributes.</em></li>
  <li><a href="./../../../mcollective/deploy/middleware/activemq.html#transport-connectors">Configure the proper URIs in the broker&#8217;s transport connectors</a>, but <em>leave off the <code>?needClientAuth=true</code> portion.</em></li>
  <li>Restart ActiveMQ.</li>
</ul>

<h3 id="step-2-configure-mcollective-servers-and-clients">Step 2: Configure MCollective Servers and Clients</h3>

<p>Set the following settings in the <code>server.cfg</code> and <code>client.cfg</code> (or <code>~/.mcollective</code>) files:</p>

<div class="highlight"><pre><code class="ini"><span class="na">connector</span> <span class="o">=</span> <span class="s">activemq</span>
<span class="c"># Optional:</span>
<span class="c"># plugin.activemq.base64 = yes</span>
<span class="na">plugin.activemq.pool.size</span> <span class="o">=</span> <span class="s">1</span>
<span class="na">plugin.activemq.pool.1.host</span> <span class="o">=</span> <span class="s">stomp.example.com</span>
<span class="na">plugin.activemq.pool.1.port</span> <span class="o">=</span> <span class="s">61614</span>
<span class="na">plugin.activemq.pool.1.user</span> <span class="o">=</span> <span class="s">mcollective</span>
<span class="na">plugin.activemq.pool.1.password</span> <span class="o">=</span> <span class="s">secret</span>
<span class="na">plugin.activemq.pool.1.ssl</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">plugin.activemq.pool.1.ssl.fallback</span> <span class="o">=</span> <span class="s">true</span>
</code></pre>
</div>

<p>The <code>plugin.activemq.pool.1.ssl.fallback</code> setting tells the plugin that it is allowed to:</p>

<ul>
  <li>Connect to an unverified server</li>
  <li>Connect without presenting its own SSL credentials</li>
</ul>

<p>&#8230;if it is missing any of the <code>.ca</code> <code>.cert</code> or <code>.key</code> settings or cannot find the files they reference. If the settings <em>are</em> present (and point to correct files), MCollective will try to do a verified connection.</p>

<h3 id="finish-verify-encryption-1">Finish: Verify Encryption</h3>

<p>If you want to be sure of this, you should now verify with tcpdump or wireshark that the connection and traffic
really is all encrypted.</p>

              <blockquote><p style="font-size: 1.3em; text-align: center;"><a href="#content">↑ Back to top</a></p></blockquote>
            </div>
            <nav class="main">
                  <div id="subCol">


<ul>
  <li><strong>Overview</strong>
    <ul>
      <li><a href="./../../../mcollective/index.html">Introduction</a></li>
      <li><a href="./../../../mcollective/overview_components.html">Overview of Components</a></li>
      <li><a href="./../../../mcollective/terminology.html">Terminology</a></li>
      <li><a href="./../../../mcollective/screencasts.html">Screencasts</a></li>
      <li><a href="./../../../mcollective/releasenotes.html">Release Notes</a></li>
      <li><a href="./../../../mcollective/changelog.html">Changelog</a></li>
    </ul>
  </li>
  <li><strong>Deploying MCollective</strong>
    <ul>
      <li><a href="./../../../mcollective/deploy/index.html">Index</a></li>
      <li><a href="./../../../mcollective/deploy/demo.html">Demo</a></li>
      <li><a href="./../../../mcollective/deploy/standard.html">Getting Started (Standard Deployment)</a></li>
    </ul>
  </li>
  <li><strong>Configuration / Deployment Topics</strong>
    <ul>
      <li><strong>Installation:</strong></li>
      <li><a href="./../../../mcollective/deploy/install.html">Installing MCollective</a></li>
      <li><a href="./../../../mcollective/deploy/plugins.html">Installing Plugins</a></li>
      <li><strong>Configuration:</strong></li>
      <li><a href="./../../../mcollective/configure/server.html">Server Config Reference</a></li>
      <li><a href="./../../../mcollective/configure/client.html">Client Config Reference</a></li>
      <li><a href="./../../../mcollective/reference/integration/puppet.html">Puppet Integration</a></li>
      <li><a href="./../../../mcollective/reference/integration/chef.html">Chef Integration</a></li>
      <li><strong>Middleware:</strong></li>
      <li><a href="./../../../mcollective/deploy/middleware/index.html">Middleware Types</a></li>
      <li><a href="./../../../mcollective/deploy/middleware/activemq.html">ActiveMQ Configs for MCollective</a></li>
      <li><a href="./../../../mcollective/deploy/middleware/activemq_keystores.html">ActiveMQ TLS Keystore Setup</a></li>
      <li><a href="./../../../mcollective/reference/integration/activemq_clusters.html">ActiveMQ Clustering</a></li>
      <li><span class="currentpage">ActiveMQ TLS</span></li>
      <li><a href="./../../../mcollective/reference/integration/activemq_security.html">ActiveMQ Security</a></li>
      <li><strong>Connector Plugins:</strong></li>
      <li><a href="./../../../mcollective/reference/plugins/connector_activemq.html">The ActiveMQ Connector</a></li>
      <li><a href="./../../../mcollective/reference/plugins/connector_rabbitmq.html">The RabbitMQ Connector</a></li>
      <li><strong>Security Plugins:</strong></li>
      <li><a href="./../../../mcollective/reference/plugins/security_ssl.html">Configuring SSL Validation Security</a></li>
      <li><strong>Advanced Features:</strong></li>
      <li><a href="./../../../mcollective/reference/basic/subcollectives.html">Subcollectives and Partitioning</a></li>
      <li><a href="./../../../mcollective/simplerpc/auditing.html">Auditing</a> <!-- contains plugin-writing info --></li>
    </ul>
  </li>
  <li><strong>Use and Administer MCollective</strong>
    <ul>
      <li><a href="./../../../mcollective/reference/basic/basic_cli_usage.html">Command Line Usage Instructions</a></li>
      <li><a href="./../../../mcollective/reference/ui/filters.html">Command Filtering and Discovery</a></li>
      <li><a href="./../../../mcollective/reference/basic/daemon.html">Controlling the MCollective Daemon</a></li>
      <li><a href="./../../../mcollective/reference/plugins/rpcutil.html">Controlling the MCollective Daemon with the rpcutil Agent</a></li>
      <li><a href="./../../../mcollective/reference/ui/nodereports.html">On-Demand Node Reports</a></li>
    </ul>
  </li>
  <li><strong>Write Agent Plugins</strong>
    <ul>
      <li><a href="./../../../mcollective/simplerpc/agents.html">Writing Agent Plugins</a></li>
      <li><a href="./../../../mcollective/reference/plugins/ddl.html">Writing DDL Files</a></li>
      <li><a href="./../../../mcollective/reference/plugins/aggregate.html">Aggregating Results</a> <!-- mixes DDL info with info about writing aggregate plugins --></li>
    </ul>
  </li>
  <li><strong>Write Clients and Applications</strong>
    <ul>
      <li><a href="./../../../mcollective/simplerpc/clients.html">Writing Clients</a></li>
      <li><a href="./../../../mcollective/reference/plugins/application.html">Writing New mco Subcommands</a></li>
    </ul>
  </li>
  <li><strong>Write Other Plugins</strong>
    <ul>
      <li><a href="./../../../mcollective/simplerpc/authorization.html">Writing Authorization Plugins and Enabling Authorization</a> <!-- contains deploy/config info --></li>
      <li><a href="./../../../mcollective/reference/plugins/data.html">Writing Data Plugins</a></li>
      <li><a href="./../../../mcollective/reference/plugins/discovery.html">Writing and Using Discovery Plugins</a> <!-- contains usage info --></li>
      <li><a href="./../../../mcollective/reference/plugins/facts.html">Writing Facts Plugins</a></li>
      <li><a href="./../../../mcollective/reference/plugins/registration.html">Writing Registration Plugins</a></li>
      <li><a href="./../../../mcollective/reference/plugins/validator.html">Writing Validator Plugins</a></li>
    </ul>
  </li>
  <li><a href="http://projects.puppetlabs.com/projects/mcollective-plugins/wiki">Plugin Directory</a></li>
  <li><strong>Internals</strong>
    <ul>
      <li><a href="./../../../mcollective/reference/basic/messageflow.html">Message Flow</a> <!-- needs more/needs update --></li>
      <li><a href="./../../../mcollective/simplerpc/index.html">SimpleRPC Overview</a></li>
      <li><a href="./../../../mcollective/simplerpc/messageformat.html">SimpleRPC Message Format</a></li>
      <li><a href="./../../../mcollective/reference/basic/messageformat.html">Core Message Format</a></li>
      <li><a href="./../../../mcollective/security.html">Security Overview</a></li>
    </ul>
  </li>
  <li><strong>Older and Non-Recommended Information</strong>
    <ul>
      <li><a href="./../../../mcollective/reference/plugins/security_aes.html">Configuring AES Security</a></li>
      <li><a href="./../../../mcollective/reference/plugins/connector_stomp.html">Configuring the Generic Stomp Connector</a></li>
      <li><a href="./../../../mcollective/reference/basic/basic_agent_and_client.html">Writing Old-Style Agent Plugins</a></li>
      <li><a href="./../../../mcollective/reference/index.html">Alternate Index</a></li>
    </ul>
  </li>
</ul>

                      <div style="margin-top: 1.5em; padding-bottom: 10px;">
                          <p style="font-family: 'Lucida Grande',Lucida,Verdana,sans-serif;font-size: 16px; font-weight: bold; line-height: 22px; margin-bottom: 10px;">Download the Docs</p>
                          <a href="http://info.puppetlabs.com/download-pdfs.html"><img src="./../../../images/smallbits_small_docs.png" alt="Puppet docs download"></a>
                      </div>
                      <div style="margin-top: 0; padding-bottom: 10px;">
                          <p style="font-family: 'Lucida Grande',Lucida,Verdana,sans-serif;font-size: 16px; font-weight: bold; line-height: 22px; margin-bottom: 10px;">Download Puppet Enterprise</p>
                          <a href="http://info.puppetlabs.com/download-pe.html"><img src="./../../../images/puppet_cert_home.jpg" alt="Puppet Enterprise promo"></a>
                      </div>
                  </div>
            </nav>
          </div>
        </div>
      </section>

		<footer id="footer">
      <div class="site-width">

        <div class="primary-secondary-content">
          <div class="primary-content">
            <section id="newsletter">
                 <h4>Puppet Labs is Hiring</h4>
                 <p><a href="http://www.puppetlabs.com/company/jobs/">Engineers, developers & consultants</a>
                  <p>
		<h4>Newsletter</h4>

              <p>Stay up to date on all things puppet</p>

				<form class="lpeRegForm formNotEmpty" method="post" enctype="application/x-www-form-urlencoded" action="http://info.puppetlabs.com/index.php/leadCapture/save"; id="mktForm_1013" name="mktForm_1013">

				<label>Email Address:</label><span class='mktInput'><input class='mktFormText mktFormEmail' name="Email" id="Email" type='text' value="" maxlength='255'  /><span class='mktFormMsg'></span></span>

				<input id='mktFrmSubmit' type='submit' class='btn' style="width: auto; overflow: visible; padding-left: .25em; padding-right: .25em;" value='Subscribe' name='submitButton' onclick='formSubmit(document.getElementById("mktForm_1013")); return false;' />

				<input style='display: none;' id='mktFrmReset' type='reset' value='Clear' name='resetButton' onclick='formReset(document.getElementById("mktForm_1013")); return false;' />

				<span style="display:none;"><input type="text" name="_marketo_comments" value="" /></span>
				<input type="hidden" name="lpId" value="-1" />
				<input type="hidden" name="subId" value="100" />

				<input type="hidden" name="kw" value="" />
				<input type="hidden" name="cr" value="" />

				<input type="hidden" name="searchstr" value="" />
				<input type="hidden" name="lpurl" value="http://info.puppetlabs.com/testsubscription.html?cr={creative}&kw={keyword}"; />
				<input type="hidden" name="formid" value="1013" />
				<input type="hidden" name="returnURL" value="http://www.puppetlabs.com/misc/subscription-thank-you/"; />
				<input type="hidden" name="retURL" value="http://www.puppetlabs.com/misc/subscription-thank-you/"; />
				<input type="hidden" name="_mkt_disp" value="return" />
				<input type="hidden" name="_mkt_trk" value="" />

				</form>
				<script type="text/javascript" src="http://info.puppetlabs.com/js/mktFormSupport.js"></script>

				<script type="text/javascript">
				function formSubmit(elt) {
				return Mkto.formSubmit(elt);
				}
				function formReset(elt) {
				return Mkto.formReset(elt);
				}
				</script>

<a href="http://info.puppetlabs.com/puppet-enterprise" class="fbtn">Try Puppet Enterprise FREE</a>

            </section>
            <section id="elsewhere">
              <h4>Get Involved</h4>
              <ul>

                <li class="chat"><a href="http://webchat.freenode.net/?channels=puppet" rel="external"><span class="indicator"></span><span>Chat with us on IRC</span></a></li>
		<li class="discussion"><a href="http://groups.google.com/group/puppet-dev" rel="external"><span class="indicator"></span><span>Join the Puppet Developer List</span></a></li>
                <li class="discussion"><a href="http://groups.google.com/group/puppet-users?pli=1" rel="external"><span class="indicator"></span><span>Join the Puppet User List</span></a></li>

                <li class="linkedin"><a href="http://www.linkedin.com/groups?about=&gid=696467&trk=anet_ug_grppro" rel="external"><span class="indicator"></span><span>Join the Puppet Users LinkedIn group</span></a></li>

              </ul>
		<p>
		              		<h4>Follow us&#8230;</h4>

              		<ul class="followus">


			<li><a href="http://feeds.feedburner.com/PuppetLabs" target="_blank"><img src="http://www.puppetlabs.com/wp-content/plugins/my-profiles/images/rss.png" border="0"></a></li>
			<li><a href="http://www.facebook.com/pages/Puppet-Labs/219089920711" target="_blank"><img src="http://www.puppetlabs.com//wp-content/plugins/my-profiles/images/facebook.png" border="0"></a></li>
			<li><a href="http://www.twitter.com/puppetlabs" target="_blank"><img src="http://www.puppetlabs.com//wp-content/plugins/my-profiles/images/twitter.png" border="0"></a></li>
			<li><a href="http://www.linkedin.com/groups?about=&amp;gid=696467&amp;trk=anet_ug_grppro" target="_blank"><img src="http://www.puppetlabs.com//wp-content/uploads/2011/01/LinkedIn_IN_Icon_32px.png" border="0"></a></li>    <li><a href="https://github.com/puppetlabs" target="_blank"><img src="http://www.puppetlabs.com//wp-content/uploads/2011/01/github_icon.png" border="0"></a></li>
			<li><a href="https://plus.google.com/112682055028218091774?rel=author" target="_blank"><img src="https://puppetlabs.com/wp-content/uploads/2013/05/google_plus32x32.png" alt="Find Us on Google+" border="0"></a></li>
					</ul>

              	</p>

            </section>
          </div>
          <div class="secondary-content">
            <section id="book-it">
              <h4>Get the book!</h4>

              <p>James Turnbull and Jeff McCune's book <a href="http://www.apress.com/9781430230571" rel="nofollow">Pro Puppet</a> is a comprehensive and up-to-date look at Puppet and MCollective. </p>
              <a href="http://www.apress.com/9781430230571" rel="nofollow"><img src="http://www.puppetlabs.com/wp-content/uploads/2011/05/propuppetthumb.png" /></a>
            </section>
          </div>
        </div>
      </div>
		</footer>

    <div id="copyright">
      <div class="site-width">
        &copy; 2011 <a href="http://www.puppetlabs.com/" title="Puppet Labs">Puppet Labs</a>
        <span class="vcard">
         <span class="org"></span>
         <a class="email" href="mailto:info@puppetlabs.com">info@puppetlabs.com</a>

          <span class="adr">
           <span class="street-address">926 NW 13th Avenue #210</span>
           /
           <span class="locality">Portland</span>,
           <span class="region">OR</span>
           <span class="postal-code">97209</span>

          </span>

         <span class="tel">1-877-575-9775</span>
        </span>
      </div>
    </div>

  	<script type="text/javascript">Cufon.now();</script>
  	<style type="text/css">h1, h2, .btn { visibility : visible; }</style>


	</body>
</html>
