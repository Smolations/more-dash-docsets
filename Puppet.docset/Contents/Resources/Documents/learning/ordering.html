<!DOCTYPE html>
<html dir="ltr" lang="en-US">
  <head>
  	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  	<title>Learning Puppet — Resource Ordering — Documentation — Puppet Labs</title>
  	<link rel="alternate" type="application/atom+xml" title="Puppet Labs Documentation Updates" href="https://github.com/puppetlabs/puppet-docs/commits/master.atom">
    <link rel="alternate" type="application/atom+xml" title="Puppet Labs Blog Feed" href="http://puppetlabs.com/feed/atom/">
    <link rel='index' title='Puppet Labs Documentation' href='http://docs.puppetlabs.com' />
    <link rel='icon' href='./../favicon.ico' />


  <meta name="description" content="DisorderLet&#8217;s look back on one of our manifests from the last page:    # /root/training-manifests/2.file.pp    file {&#39;/tmp/test1&#39;:   ...">



    <!-- FIXME: absolute paths -->

    <script type='text/javascript' src='./../files/javascripts/html5.js'></script>
    <script type='text/javascript' src='./../files/javascripts/jquery-1.3.2.min.js'></script>
    <script type='text/javascript' src='./../files/javascripts/drop_down.js'></script>
    <script type='text/javascript' src='./../files/javascripts/cufon-yui.js'></script>
    <script type='text/javascript' src='./../files/fonts/Klavika_400-Klavika_600.font.js'></script>
    <script type='text/javascript' src='./../files/javascripts/ampersands.js'></script>
    <script type='text/javascript' src='./../files/javascripts/navigation-accordion.js'></script>

    <script type="text/javascript" src="http://puppetlabs.com/wp-content/themes/puppetlabs/javascripts/leadcapture.js"></script>

    <!-- All in One SEO Pack 1.6.10.1 by Michael Torbert of Semper Fi Web Design[127,146] -->
    <meta name="keywords" content="Puppet, puppet labs, reductive labs, open source, system administrator, ruby, data center, automation, support" />
    <!-- /all in one seo pack -->

    <!-- Give us the option of setting a canonical URL in yaml frontmatter -NF -->
    <link rel="canonical" href="http://docs.puppetlabs.com/learning/ordering.html" />

    <!-- FIXME: absolute paths -->

    <link rel="stylesheet" type="text/css" href="./../files/stylesheets/style.css" media="screen">
    <link rel="stylesheet" type="text/css" href="./../files/stylesheets/syntax.css" media="screen"> <!-- index -->
    <link rel="stylesheet" type="text/css" href="./../files/stylesheets/adbanner.css" media="screen">

    <!--[if IE 7]>
	  <link rel="stylesheet" type="text/css" href="./../files/stylesheets/ie_7.css" media="screen"> <!-- index -->
    <![endif]-->

    <!--[if IE 8]>
	    <link rel="stylesheet" type="text/css" href="./../files/stylesheets/ie_8.css" media="screen"> <!-- index -->
    <![endif]-->

  	<script type="text/javascript">
      Cufon.replace('h1, h2', { fontWeight: '600' });
  	</script>
</head>




  <body id="puppetlabsdocs" class="docs">
  <style type="text/css">h1, h2{ visibility : hidden }</style>
  <!--[if IE 8]>
    <style type="text/css">h1, h2{ visibility : visible }</style>
  <![endif]-->

  	<header id="header">
      <div class="site-width">
    		<h1><a href="http://puppetlabs.com/"><span>Puppet Labs</span></a></h1>
        <a class="screen-reader-content" href="#content">Skip navigation</a>
        <nav>
    		<ul id="global-navigation">
          <li id="puppet-tab" class="with-submenu">
            <a href="http://puppetlabs.com/puppet/puppet-enterprise">
              <span>Products</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
			<li>
                <ul>
                   <a href="http://puppetlabs.com/puppet/what-is-puppet/">What is Puppet?</a>
                </ul>
              </li>
			       <li>
                <ul>
                   <a href="http://puppetlabs.com/puppet/puppet-enterprise/">Puppet Enterprise</a>
                </ul>
              </li>
            <li>
                <ul>
                   <a href="http://puppetlabs.com/puppet/whats-new/">What's New in 2.5</a>
                </ul>
              </li>
            <li>
                <ul>
                   <a href="http://puppetlabs.com/puppet/puppet-open-source/">Puppet Open Source</a>
                </ul>
              </li>
            <li>
                <ul>
                   <a href="http://puppetlabs.com/puppet/enterprise-vs-open-source/">Enterprise vs. Open Source</a>
                </ul>
              </li>
              <li>
                <ul>
                  <a href="http://forge.puppetlabs.com">Puppet Forge</a>
                </ul>
              </li>
              <li>
                <ul>
                  <a href="http://puppetlabs.com/puppet/requirements/">Components &amp; Requirements</a>
                </ul>
              </li>
              <li>
                <ul>
                  <a href="http://puppetlabs.com/puppet/faq/">FAQ</a>
                </ul>
              </li>
			  <li>
                <ul>
                  <a href="http://puppetlabs.com/puppet/how-to-buy/">How to Buy</a>
                </ul>
              </li>
            </ul>
          </li>
          <li id="solutions-tab" class="with-submenu">
            <a href="http://puppetlabs.com/solutions/">
              <span>Solutions</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
              <li class="page_item page-item-12296"><a href="http://puppetlabs.com/solutions/configuration-management/">Configuration Management</a></li>
<li class="page_item page-item-986"><a href="http://puppetlabs.com/solutions/virtualization-management/">Virtualization Management</a></li>
<li class="page_item page-item-993"><a href="http://puppetlabs.com/solutions/cloud-management/">Cloud Management</a></li>
<li class="page_item page-item-996"><a href="http://puppetlabs.com/solutions/it-compliance/">IT Compliance</a></li>
<li class="page_item page-item-9520"><a href="http://puppetlabs.com/solutions/devops/">DevOps</a></li>
<li class="page_item page-item-991"><a href="http://puppetlabs.com/solutions/manage-os-x-resources/">OS X Desktops</a></li>
            </ul>
          </li>
          <li id="services-tab" class="with-submenu">
            <a href="http://puppetlabs.com/services/">
              <span>Services</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
              <li class="page_item page-item-783"><a href="http://puppetlabs.com/services/overview/">Overview</a></li>
<li class="page_item page-item-1052"><a href="http://puppetlabs.com/services/customer-support/">Customer Support</a></li>
<li class="page_item page-item-11022"><a href="http://puppetlabs.com/services/support-plans/">Support Plans</a></li>
<li class="page_item page-item-845"><a href="http://puppetlabs.com/services/training-workshops/">On-Site Education</a></li>
<li class="page_item page-item-4899"><a href="http://puppetlabs.com/services/consulting/">Professional Services</a></li>
<li class="page_item page-item-849"><a href="http://puppetlabs.com/category/events/upcoming/">Events &amp; Workshops</a></li>
<li class="page_item page-item-851"><a href="http://puppetlabs.com/services/partners/">Partners</a></li>
            </ul>
          </li>
                    <li id="resources-tab" class="with-submenu">
            <a href="http://puppetlabs.com/resources/">
              <span>Resources</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
              <li class="page_item page-item-1048"><a href="http://puppetlabs.com/resources/overview-2/">Overview</a></li>
<li class="page_item page-item-1040"><a href="http://docs.puppetlabs.com">Documentation</a></li>
<li class="page_item page-item-872"><a href="http://info.puppetlabs.com/register-download">Downloads</a></li>
<li class="page_item page-item-1961"><a href="http://forge.puppetlabs.com">Puppet Forge</a></li>
<li class="page_item page-item-835"><a href="http://info.puppetlabs.com/download-whitepapers.html">White Papers</a></li>
<li class="page_item page-item-1967"><a href="http://projects.puppetlabs.com/projects/puppet/wiki">Wiki</a></li>
<li class="page_item page-item-7279"><a href="http://puppetlabs.com/resources/webinars/">Upcoming Webinars</a></li>
<li class="page_item page-item-10183"><a href="http://puppetlabs.com/resources/newsletter/">Newsletter</a></li>
<li class="page_item page-item-12263"><a href="http://puppetlabs.com/resources/tech-notes/">Tech Notes</a></li>
<li class="page_item page-item-10265"><a href="http://info.puppetlabs.com/pe2-webinar.html">Webinars</a></li>
            </ul>
          </li>

          <li id="customers-tab" class="with-submenu">
            <a href="http://puppetlabs.com/customers/companies/">
              <span>Customers</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
			<li>
                <ul>
                  <a href="http://puppetlabs.com/customers/companies/">Companies</a>
                </ul>
              </li>
			  <li>
                <ul>
                  <a href="http://puppetlabs.com/customers/case-studies/">Case Studies</a>
                </ul>
              </li>
			  <li>
                <ul>
                  <a href="http://puppetlabs.com/customers/product-testimonials/">Product Testimonials</a>
                </ul>
              </li>
			    <li>
                <ul>
                  <a href="http://puppetlabs.com/customers/what-customers-are-saying/">Service Testimonials</a>
                </ul>
              </li>
            </ul>
          </li>
          <li id="community-tab" class="with-submenu">
            <a href="http://puppetlabs.com/community/">
              <span>Community</span>
              <span class="drop-down-trigger"></span>
            </a>

 <ul>
			<li>
                <ul>
                  <a href="http://puppetlabs.com/community/overview/">Overview</a>
                </ul>
              </li>
			<li>
                <ul>
                  <a href="http://puppetlabs.com/blog">Blog</a>
                </ul>
              </li>
			  <li>
                <ul>
                  <a href="http://puppetlabs.com/community/puppet-camp/">Puppet Camp</a>
                </ul>
              </li>
			  <li>
                <ul>
                  <a href="http://puppetlabs.com/community/user-groups-and-devops-groups/">Puppet User Groups & DevOps Groups</a>
                </ul>
              </li>
	          <li>
                <ul>
                  <a href="http://puppetlabs.com/community/presentations/">Presentations</a>
                </ul>
              </li>
			    <li>
                <ul>
                  <a href="http://puppetlabs.com/community/videos/">Videos</a>
                </ul>
              </li>
            </ul>

          <li id="company-tab" class="with-submenu">
            <a href="http://puppetlabs.com/company/">
              <span>Company</span>
              <span class="drop-down-trigger"></span>
            </a>
            <ul>
              <li class="page_item page-item-2316"><a href="http://puppetlabs.com/company/overview/">Overview</a></li>
<li class="page_item page-item-2179"><a href="http://puppetlabs.com/company/news/">News</a>
<ul class='children'>
	<li class="page_item page-item-2338"><a href="http://puppetlabs.com/company/news/press-releases/">Press Releases</a></li>
	<li class="page_item page-item-2383"><a href="http://puppetlabs.com/company/news/media-kit/">Media Kit</a></li>
</ul>
</li>
<li class="page_item page-item-1571"><a href="http://puppetlabs.com/company/careers/">Careers</a></li>
<li class="page_item page-item-10372"><a href="http://puppetlabs.com/company/management/">Management</a></li>
<li class="page_item page-item-10311"><a href="http://puppetlabs.com/company/board-and-advisors/">Board and Advisors</a></li>
<li class="page_item page-item-10367"><a href="http://puppetlabs.com/company/investors/">Investors</a></li>
<li class="page_item page-item-2313"><a href="http://puppetlabs.com/company/contact-us/">Contact Us</a></li>
<li class="page_item page-item-10579"><a href="http://puppetlabs.com/company/awards/">Awards</a></li>
            </ul>
          </li>
    		</ul>
          <div id="misc-navigation">
			  <ul>
				<li><a href="http://puppetlabs.com/security/">Security</a></li>
				<li><a href="http://docs.puppetlabs.com">Documentation</a></li>
				<li><a href="http://puppetlabs.com/resources/customer-support/">Support</a></li>
			        <li><a href="http://projects.puppetlabs.com/">Bug Tracker</a></li>
				<li><a href="http://puppetlabs.com/company/contact/contact-us">Contact Us</a></li>
				<li><a href="http://info.puppetlabs.com/download-pe2.html" class="gateway">Download</a></li>
			  </ul>
			<form action="http://www.google.com/cse" id="cse-search-box">
			  <div>
				<input type="hidden" name="cx" value="017668764424496204839:ubligvgbenm" />
				<input type="hidden" name="ie" value="UTF-8" />
				<input type="text" name="q" class="gsc-input" size="31" />
				<input type="submit" name="sa" class="searchbtn" value="Search" />
			  </div>
			</form>
			<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en"></script>
          </div>
      </nav>
    	</div>
    </header>

      <section id="masthead">
        <div class="site-width">
          <h1>Docs: <span class="section-name">Learning Puppet — Resource Ordering</span></h1>
          <ul id="doc-navigation">
            <li><a href="./../index.html">Docs Home</a></li>
            <li class="with-submenu">
              <a href="#">
                <span>Quick Nav</span>
                <span class="drop-down-trigger"></span>
              </a>
               <!-- the following links can't be relative, unfortunately -->
               <!-- future: add some JS to disable this if running from file:// -->
                               <dl>
                  <dt>Puppet Documentation</dt>
                      <dd><a href="./../puppet/3/reference/index.html">Puppet 3 Reference Manual</a></dd>
                      <dd><a href="./../puppet/2.7/reference/index.html">Puppet 2.7 Reference Manual</a></dd>
                      <dd><a href="./../pe/latest/index.html">Puppet Enterprise User's Guide</a></dd>
                      <dd><a href="./../learning/index.html">Learning Puppet</a></dd>
                      <dd><a href="./../references/latest/type.html">Resource Types</a></dd>
                      <dd><a href="./../references/latest/function.html">Functions</a></dd>
                      <dd><a href="./../references/latest/configuration.html">Configuration</a></dd>
                      <dd><a href="./../references/latest/developer/index.html">Developer</a></dd>
                      <dd><a href="./../references/glossary.html">Glossary of Puppet Terms</a></dd>
                      <dd><a href="./../references/index.html">Older References</a></dd>
                  <dt>Facter</dt>
                      <dd><a href="./../facter/latest/core_facts.html">Core Facts Reference</a></dd>
                  <dt>PuppetDB</dt>
                      <dd><a href="./../puppetdb/1/index.html">PuppetDB 1 Manual</a></dd>
                  <dt>MCollective</dt>
                      <dd><a href="./../mcollective/index.html">Index</a></dd>
                      <dd><a href="./../mcollective/reference/index.html">References</a></dd>
                      <dd><a href="./../mcollective/simplerpc/index.html">Writing Plugins</a></dd>
                      <dd><a href="./../mcollective/releasenotes.html">Release Notes</a></dd>
                </dl>

            </li>
            <li><a href="./../contribute.html">Contribute</a></li>
          </ul>
        </div>
        <br />
      </section>

      <section id="content">
        <div class="site-width">
          <div class="primary-secondary-content">
            <div class="primary-content">
              <h1>Learning Puppet — Resource Ordering</h1>
              <nav class="in-page" id="page-nav">
<ol class="toc">
  <li class="toc-lv2"><a href="#disorder">Disorder</a>
<ol class="toc">
   <li class="toc-lv3"><a href="#summary-of-this-page">Summary of This Page</a></li>
</ol></li>
  <li class="toc-lv2"><a href="#metaparameters-resource-references-and-ordering">Metaparameters, Resource References, and Ordering</a>
<ol class="toc">
   <li class="toc-lv3"><a href="#before-and-require">Before and Require</a></li>
   <li class="toc-lv3"><a href="#notify-and-subscribe">Notify and Subscribe</a></li>
</ol></li>
  <li class="toc-lv2"><a href="#chaining-arrows">Chaining Arrows</a></li>
  <li class="toc-lv2"><a href="#autorequire">Autorequire</a></li>
  <li class="toc-lv2"><a href="#example-sshd">Example: sshd</a>
<ol class="toc">
   <li class="toc-lv3"><a href="#prepare">Prepare</a></li>
   <li class="toc-lv3"><a href="#manage">Manage</a></li>
   <li class="toc-lv3"><a href="#break">Break</a></li>
   <li class="toc-lv3"><a href="#fix">Fix</a></li>
</ol></li>
  <li class="toc-lv2"><a href="#packagefileservice">Package/File/Service</a>
<ol class="toc">
   <li class="toc-lv3"><a href="#exercise-apache">Exercise: Apache</a></li>
</ol></li>
  <li class="toc-lv2"><a href="#next">Next</a></li>
</ol></nav>

<h2 id="disorder">Disorder</h2>

<p>Let&#8217;s look back on one of our manifests from the last page:</p>

<div class="highlight"><pre><code class="ruby">    <span class="c1"># /root/training-manifests/2.file.pp</span>

    <span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/tmp/test1&#39;</span><span class="p">:</span>
      <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
      <span class="n">content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Hi.&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/tmp/test2&#39;</span><span class="p">:</span>
      <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">directory</span><span class="p">,</span>
      <span class="n">mode</span>   <span class="o">=&gt;</span> <span class="mi">644</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/tmp/test3&#39;</span><span class="p">:</span>
      <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="p">,</span>
      <span class="n">target</span> <span class="o">=&gt;</span> <span class="s1">&#39;/tmp/test1&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">notify</span> <span class="p">{</span><span class="s2">&quot;I&#39;m notifying you.&quot;</span><span class="p">:}</span>
    <span class="n">notify</span> <span class="p">{</span><span class="s2">&quot;So am I!&quot;</span><span class="p">:}</span>
</code></pre>
</div>

<p>When we ran this, the resources weren&#8217;t synced in the order we wrote them: it went <code>/tmp/test1</code>, <code>/tmp/test3</code>, <code>/tmp/test2</code>, <code>So am I!</code>, and <code>I'm notifying you.</code></p>

<p>Like we mentioned in the last chapter, Puppet combines &#8220;check the state&#8221; and &#8220;fix any problems&#8221; into a single declaration for each resource. Since each resource is represented by one atomic statement, ordering within a file matters a lot less than it would for an equivalent script.</p>

<p>Or rather, it matters less as long as the resources are independent and not related to each other. And most resources are! But some resources depend on other resources. Consider a service which is installed by a package &#8212; it&#8217;s impossible to get the service into its desired state if the package isn&#8217;t installed yet. The service has a <em>dependency</em> on the package.</p>

<p>So when dealing with related resources, Puppet has ways to express those relationships.</p>

<blockquote>
  <h3 id="summary-of-this-page">Summary of This Page</h3>

  <ul>
    <li>You can embed relationship information in a resource with the <code>before</code>, <code>require</code>, <code>notify</code>, and <code>subscribe</code> metaparameters.</li>
    <li>You can also declare relationships outside a resource with the <code>-&gt;</code> and <code>~&gt;</code> chaining arrows.</li>
    <li>Relationships can be either ordering (this before that) or ordering-with-notification (this before that, and tell that whether this was changed).</li>
    <li>Puppet&#8217;s relationship behaviors and syntaxes are documented in <a href="./../puppet/latest/reference/lang_relationships.html">the Puppet reference manual page on relationships.</a></li>
  </ul>
</blockquote>

<h2 id="metaparameters-resource-references-and-ordering">Metaparameters, Resource References, and Ordering</h2>

<p>Here&#8217;s a notify resource that depends on a file resource:</p>

<div class="highlight"><pre><code class="ruby">    <span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/tmp/test1&#39;</span><span class="p">:</span>
      <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
      <span class="n">content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Hi.&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">notify</span> <span class="p">{</span><span class="s1">&#39;/tmp/test1 has already been synced.&#39;</span><span class="p">:</span>
      <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/tmp/test1&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>Each resource type has its own set of attributes, but there&#8217;s another set of attributes, called <a href="./../puppet/latest/reference/lang_resources.html#metaparameters">metaparameters</a>, which can be used on any resource. (They&#8217;re &#8220;meta&#8221; because they don&#8217;t describe any feature of the resource that you could observe on the system after Puppet finishes; they only describe how Puppet should act.)</p>

<p>There are four metaparameters that let you arrange resources in order:</p>

<ul>
  <li><code>before</code></li>
  <li><code>require</code></li>
  <li><code>notify</code></li>
  <li><code>subscribe</code></li>
</ul>

<p>All of them accept a <a href="./../puppet/latest/reference/lang_datatypes.html#resource-references"><strong>resource reference</strong></a> (or an <a href="/puppet/latest/reference/lang_datatypes.html#arrays">array</a> of them) as their value. Resource references look like this:</p>

<div class="highlight"><pre><code class="ruby">    <span class="no">Type</span><span class="o">[</span><span class="s1">&#39;title&#39;</span><span class="o">]</span>
</code></pre>
</div>

<p>(Note the square brackets and capitalized resource type!)</p>

<blockquote>
  <h4 id="aside-when-to-capitalize">Aside: When to Capitalize</h4>

  <p>The easy way to remember this is that you <em>only</em> use the lowercase type name when <em>declaring a new resource.</em> Any other situation will always call for a capitalized type name.</p>
</blockquote>

<h3 id="before-and-require">Before and Require</h3>

<p><code>before</code> and <code>require</code> make simple dependency relationships, where one resource must be synced before another. <code>before</code> is used in the earlier resource, and lists resources that depend on it; <code>require</code> is used in the later resource, and lists the resources that it depends on.</p>

<p>These two metaparameters are just different ways of writing the same relationship &#8212; our example above could just as easily be written like this:</p>

<div class="highlight"><pre><code class="ruby">    <span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/tmp/test1&#39;</span><span class="p">:</span>
      <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
      <span class="n">content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Hi.&quot;</span><span class="p">,</span>
      <span class="n">before</span>  <span class="o">=&gt;</span> <span class="no">Notify</span><span class="o">[</span><span class="s1">&#39;/tmp/test1 has already been synced.&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">notify</span> <span class="p">{</span><span class="s1">&#39;/tmp/test1 has already been synced.&#39;</span><span class="p">:}</span>
</code></pre>
</div>

<h3 id="notify-and-subscribe">Notify and Subscribe</h3>

<p>A few resource types (<code>service</code>, <code>exec</code>, and <code>mount</code>) can be <strong>&#8220;refreshed&#8221;</strong> &#8212; that is, told to react to changes in their environment. For a service, this usually means restarting when a config file has been changed; for an <code>exec</code> resource, this could mean running its payload if any user accounts have been changed. (Note that refreshes are performed by Puppet, so they only occur during Puppet runs.)</p>

<p>The <code>notify</code> and <code>subscribe</code> metaparameters make dependency relationships the way <code>before</code> and <code>require</code> do, but they also make <strong>notification relationships.</strong> Not only will the earlier resource in the pair get synced first, but if Puppet makes any changes to that resource, it will send a refresh event to the later resource, which will react accordingly.</p>

<p>An example of a notification relationship:</p>

<div class="highlight"><pre><code class="ruby">    <span class="n">file</span> <span class="p">{</span> <span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="p">:</span>
      <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">file</span><span class="p">,</span>
      <span class="n">mode</span>   <span class="o">=&gt;</span> <span class="mi">600</span><span class="p">,</span>
      <span class="n">source</span> <span class="o">=&gt;</span> <span class="s1">&#39;puppet:///modules/ssh/sshd_config&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">service</span> <span class="p">{</span> <span class="s1">&#39;sshd&#39;</span><span class="p">:</span>
      <span class="k">ensure</span>    <span class="o">=&gt;</span> <span class="n">running</span><span class="p">,</span>
      <span class="n">enable</span>    <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
      <span class="n">subscribe</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>In this example, the <code>sshd</code> service will be restarted if Puppet has to edit its config file.</p>

<h2 id="chaining-arrows">Chaining Arrows</h2>

<p>There&#8217;s one last way to declare relationships: chain resource references with the <a href="./../puppet/latest/reference/lang_relationships.html#chaining-arrows">ordering (<code>-&gt;</code>) and notification (<code>~&gt;</code>; note the tilde) arrows.</a> Think of them as representing the flow of time: the resource behind the arrow will be synced <em>before</em> the resource the arrow points at.</p>

<p>This example causes the same dependency as the similar examples above:</p>

<div class="highlight"><pre><code class="ruby">    <span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/tmp/test1&#39;</span><span class="p">:</span>
      <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
      <span class="n">content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Hi.&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">notify</span> <span class="p">{</span><span class="s1">&#39;after&#39;</span><span class="p">:</span>
      <span class="n">message</span> <span class="o">=&gt;</span> <span class="s1">&#39;/tmp/test1 has already been synced.&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/tmp/test1&#39;</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="no">Notify</span><span class="o">[</span><span class="s1">&#39;after&#39;</span><span class="o">]</span>
</code></pre>
</div>

<p>Chaining arrows can take several things as their operands: this example uses resource references, but they can also take resource declarations and <a href="./../puppet/latest/reference/lang_collectors.html">resource collectors</a>.</p>

<p>Since whitespace is freely adjustable in Puppet, and since chaining arrows can go between resource declarations, it&#8217;s easy to make a short run of resources be synced in the order they&#8217;re written &#8212; just put chaining arrows between them:</p>

<div class="highlight"><pre><code class="ruby">    <span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/tmp/test1&#39;</span><span class="p">:</span>
      <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
      <span class="n">content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Hi.&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="o">-&gt;</span>
    <span class="n">notify</span> <span class="p">{</span><span class="s1">&#39;after&#39;</span><span class="p">:</span>
      <span class="n">message</span> <span class="o">=&gt;</span> <span class="s1">&#39;/tmp/test1 has already been synced.&#39;</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>Again, this creates the same relationship we&#8217;ve seen previously.</p>

<h2 id="autorequire">Autorequire</h2>

<p>Some of Puppet&#8217;s resource types will notice when an instance is related to other resources, and they&#8217;ll set up automatic dependencies. The one you&#8217;ll use most often is between files and their parent directories: if a given file and its parent directory are both being managed as resources, Puppet will make sure to sync the parent directory before the file. <strong>This never creates new resources;</strong> it only adds dependencies to resources that are already being managed.</p>

<p>Don&#8217;t sweat much about the details of autorequiring; it&#8217;s fairly conservative and should generally do the right thing without getting in your way. If you forget it&#8217;s there and make explicit dependencies, your code will still work. Explicit dependencies will also override autorequires, if they conflict.</p>

<h2 id="example-sshd">Example: sshd</h2>

<p>Hopefully that&#8217;s all pretty clear! But even if it is, it&#8217;s rather abstract &#8212; making sure a notify fires after a file is something of a &#8220;hello world&#8221; use case, and not very illustrative. Let&#8217;s break something!</p>

<p>You&#8217;ve probably been using SSH and your favorite terminal app to interact with the Learning Puppet VM, so let&#8217;s go straight for the most-annoying-case scenario: we&#8217;ll pretend someone accidentally gave the wrong person (i.e., us) sudo privileges, and they ruined root&#8217;s ability to SSH to this box.</p>

<h3 id="prepare">Prepare</h3>

<p>Let&#8217;s get a copy of the current sshd config file; going forward, we&#8217;ll use our new copy as the canonical source for that file.</p>

<pre><code># cp /etc/ssh/sshd_config ~/examples/
</code></pre>

<p>Now we&#8217;ll write some Puppet code to manage the file:</p>

<div class="highlight"><pre><code class="ruby">    <span class="c1"># /root/examples/break_ssh.pp (incomplete)</span>
    <span class="n">file</span> <span class="p">{</span> <span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="p">:</span>
      <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">file</span><span class="p">,</span>
      <span class="n">mode</span>   <span class="o">=&gt;</span> <span class="mi">600</span><span class="p">,</span>
      <span class="n">source</span> <span class="o">=&gt;</span> <span class="s1">&#39;/root/examples/sshd_config&#39;</span><span class="p">,</span>
      <span class="c1"># And yes, that&#39;s the first time we&#39;ve used the &quot;source&quot; attribute. It accepts</span>
      <span class="c1"># absolute local paths and puppet:/// URLs, which we&#39;ll say more about later.</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>This is only half of what we need, though. It will change the config file, but those changes will only take effect when the service restarts, which could be years from now.</p>

<p>To make the service restart whenever we make changes to the config, we should tell Puppet to manage the <code>sshd</code> service and have it subscribe to the config file:</p>

<div class="highlight"><pre><code class="ruby">    <span class="c1"># /root/examples/break_ssh.pp</span>
    <span class="n">file</span> <span class="p">{</span> <span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="p">:</span>
      <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">file</span><span class="p">,</span>
      <span class="n">mode</span>   <span class="o">=&gt;</span> <span class="mi">600</span><span class="p">,</span>
      <span class="n">source</span> <span class="o">=&gt;</span> <span class="s1">&#39;/root/examples/sshd_config&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">service</span> <span class="p">{</span> <span class="s1">&#39;sshd&#39;</span><span class="p">:</span>
      <span class="k">ensure</span>     <span class="o">=&gt;</span> <span class="n">running</span><span class="p">,</span>
      <span class="n">enable</span>     <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
      <span class="n">subscribe</span>  <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre>
</div>

<h3 id="manage">Manage</h3>

<p>Great, we have our Puppet code; now paste it into <code>/etc/puppetlabs/puppet/manifests/site.pp</code>, so that puppet agent will manage those resources.</p>

<h3 id="break">Break</h3>

<p>Next, edit the original <code>/etc/ssh/sshd_config</code> file. There&#8217;s a commented-out line in there that says <code>#PermitRootLogin yes</code>; find it, remove the comment, and change the yes to a no:</p>

<pre><code>PermitRootLogin no
</code></pre>

<p>Now manually restart the sshd service:</p>

<pre><code># service sshd restart
</code></pre>

<p>&#8230; and log out. You should no longer be able to log in as root over SSH; test it to make sure. (Although you can still log in via your virtualization software&#8217;s console.)</p>

<h3 id="fix">Fix</h3>

<p>Actually, now that you&#8217;ve added those resources to site.pp, Puppet will fix this automatically within about half an hour. But if you&#8217;re impatient, you can <a href="./ral.html#logging-in">log in to the Puppet Enterprise console</a>, then <a href="./../pe/latest/console_live_puppet.html">trigger a puppet agent run</a> in the live management page.</p>

<p>And that&#8217;ll do it! After the Puppet run has completed and you can see the report appear in the console (it will have a blue icon, to show that changes were made), you should be able to log in as root via SSH again. <em>Victory.</em></p>

<blockquote>
  <h4 id="no-changes-no-refresh">No Changes? No Refresh</h4>

  <p>There&#8217;s an odd situation you can get into if you apply a manifest that makes config file changes before you finish writing it.</p>

  <p>Puppet only sends refresh events if it makes changes to the notifying resource in <em>this run.</em> So if you wrote a file resource with new desired content for a config file, applied the manifest, then edited the manifest again to create a refresh relationship with a service, the service would miss its refresh, since the file resource would already be in its desired state.</p>

  <p>This will generally only happen to you on the machines you&#8217;re testing early versions of manifests on, rather than your production boxes. If it does bite you, you can restart the service manually with <a href="./../pe/latest/console_navigating_live_mgmt.html#the-advanced-tasks-tab">the &#8220;Advanced Tasks&#8221; section of the PE console&#8217;s live management page</a> &#8212; use the &#8220;restart&#8221; action in the &#8220;service tasks&#8221; section.</p>
</blockquote>

<h2 id="packagefileservice">Package/File/Service</h2>

<p>The example we just saw was very close to a pattern you&#8217;ll see constantly in production Puppet code, but it was missing a piece. Let&#8217;s complete it:</p>

<div class="highlight"><pre><code class="ruby">    <span class="c1"># /root/examples/break_ssh.pp</span>
    <span class="n">package</span> <span class="p">{</span> <span class="s1">&#39;openssh-server&#39;</span><span class="p">:</span>
      <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
      <span class="n">before</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">file</span> <span class="p">{</span> <span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="p">:</span>
      <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">file</span><span class="p">,</span>
      <span class="n">mode</span>   <span class="o">=&gt;</span> <span class="mi">600</span><span class="p">,</span>
      <span class="n">source</span> <span class="o">=&gt;</span> <span class="s1">&#39;/root/examples/sshd_config&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">service</span> <span class="p">{</span> <span class="s1">&#39;sshd&#39;</span><span class="p">:</span>
      <span class="k">ensure</span>     <span class="o">=&gt;</span> <span class="n">running</span><span class="p">,</span>
      <span class="n">enable</span>     <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
      <span class="n">subscribe</span>  <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>This is the <strong>package/file/service</strong> pattern, one of the most useful idioms in Puppet: the package resource makes sure the software and its config file are installed, the config file depends on the package resource, and the service subscribes to changes in the config file.</p>

<p>It&#8217;s hard to overstate the importance of this pattern! If you stopped here and only learned this, you could still get a lot of work done.</p>

<blockquote>
  <h3 id="exercise-apache">Exercise: Apache</h3>

  <p>Write and apply a manifest that will install the Apache <a href="http://docs.puppetlabs.com/references/latest/type.html#package">package</a>, then make sure the Apache <a href="http://docs.puppetlabs.com/references/latest/type.html#service">service</a> is running. Prove that it worked by using a web browser on your host OS to view the Apache welcome page.</p>

  <p><strong>Bonus work:</strong> Manage the httpd.conf file, and have it notify the service. Force Apache to be kept at a certain version (note that you&#8217;ll have to research the format of the version strings for your operating system, as well as which versions are available).</p>

  <p>Hints:</p>

  <ul>
    <li>On modern Red Hat-like (your VM) and Debian-like Linux systems, packages are installed from the operating system&#8217;s Apt or Yum repositories. Since the system tools know how to find and install a package (or even a specific version of a package), all Puppet needs to know is <code>ensure =&gt; installed</code>; it doesn&#8217;t need to know where the package lives.</li>
    <li>The names of package and service resources depend on the OS&#8217;s own naming conventions. This means you often need to do a bit of research before writing a manifest, to learn what the local name for, e.g., the Apache package and service are. On CentOS, which your VM runs, both the package and service are named <code>httpd</code>.</li>
    <li>Make sure you&#8217;re using the right <code>ensure</code> values for each resource type; they aren&#8217;t the same for package, file, and service.</li>
    <li>The <a href="http://docs.puppetlabs.com/puppet_core_types_cheatsheet.pdf">core types cheat sheet</a> and the <a href="http://docs.puppetlabs.com/references/stable/type.html">type reference</a> are your friends.</li>
  </ul>
</blockquote>

<h2 id="next">Next</h2>

<p><strong>Next Lesson:</strong></p>

<p>Now that you can express dependencies between resources, it&#8217;s time to make your manifests more aware of the outside world with <a href="./variables.html">variables, facts, and conditionals</a>.</p>

<p><strong>Off-Road:</strong></p>

<p>Now that you can manage a complete service from top to bottom, try managing an important service on your own test systems. <a href="http://info.puppetlabs.com/download-pe.html">Download Puppet Enterprise for free</a>, follow <a href="http://docs.puppetlabs.com/pe/latest/quick_start.html">the quick start guide</a> to get a small environment installed, then try building a package/file/service pattern at the bottom of the puppet master&#8217;s <code>/etc/puppetlabs/puppet/manifests/site.pp</code> file. MySQL? Memcached? You decide.</p>


              <blockquote><p style="font-size: 1.3em; text-align: center;"><a href="#content">↑ Back to top</a></p></blockquote>
            </div>
            <nav class="main">
                  <div id="subCol">


<ul>
  <li><a href="./../learning/index.html">Introduction</a></li>
  <li><strong>Part one: Serverless Puppet</strong>
    <ul>
      <li><a href="./../learning/ral.html">Resources and the RAL</a></li>
      <li><a href="./../learning/manifests.html">Manifests</a></li>
      <li><span class="currentpage">Ordering</span></li>
      <li><a href="./../learning/variables.html">Variables, Conditionals, Facts</a></li>
      <li><a href="./../learning/modules1.html">Modules and Classes</a></li>
      <li><a href="./../learning/templates.html">Templates</a></li>
      <li><a href="./../learning/modules2.html">Class Parameters</a></li>
      <li><a href="./../learning/definedtypes.html">Defined Types</a></li>
    </ul>
  </li>
  <li><strong>Part two: Master/Agent Puppet</strong>
    <ul>
      <li><a href="./../learning/agentprep.html">Preparing an Agent VM</a></li>
      <li><a href="./../learning/agent_master_basic.html">Basic Agent/Master Puppet</a></li>
    </ul>
  </li>
</ul>

                      <div style="margin-top: 1.5em; padding-bottom: 10px;">
                          <p style="font-family: 'Lucida Grande',Lucida,Verdana,sans-serif;font-size: 16px; font-weight: bold; line-height: 22px; margin-bottom: 10px;">Download the Docs</p>
                          <a href="http://info.puppetlabs.com/download-pdfs.html"><img src="./../images/smallbits_small_docs.png" alt="Puppet docs download"></a>
                      </div>
                      <div style="margin-top: 0; padding-bottom: 10px;">
                          <p style="font-family: 'Lucida Grande',Lucida,Verdana,sans-serif;font-size: 16px; font-weight: bold; line-height: 22px; margin-bottom: 10px;">Download Puppet Enterprise</p>
                          <a href="http://info.puppetlabs.com/download-pe.html"><img src="./../images/puppet_cert_home.jpg" alt="Puppet Enterprise promo"></a>
                      </div>
                  </div>
            </nav>
          </div>
        </div>
      </section>

		<footer id="footer">
      <div class="site-width">

        <div class="primary-secondary-content">
          <div class="primary-content">
            <section id="newsletter">
                 <h4>Puppet Labs is Hiring</h4>
                 <p><a href="http://www.puppetlabs.com/company/jobs/">Engineers, developers & consultants</a>
                  <p>
		<h4>Newsletter</h4>

              <p>Stay up to date on all things puppet</p>

				<form class="lpeRegForm formNotEmpty" method="post" enctype="application/x-www-form-urlencoded" action="http://info.puppetlabs.com/index.php/leadCapture/save"; id="mktForm_1013" name="mktForm_1013">

				<label>Email Address:</label><span class='mktInput'><input class='mktFormText mktFormEmail' name="Email" id="Email" type='text' value="" maxlength='255'  /><span class='mktFormMsg'></span></span>

				<input id='mktFrmSubmit' type='submit' class='btn' style="width: auto; overflow: visible; padding-left: .25em; padding-right: .25em;" value='Subscribe' name='submitButton' onclick='formSubmit(document.getElementById("mktForm_1013")); return false;' />

				<input style='display: none;' id='mktFrmReset' type='reset' value='Clear' name='resetButton' onclick='formReset(document.getElementById("mktForm_1013")); return false;' />

				<span style="display:none;"><input type="text" name="_marketo_comments" value="" /></span>
				<input type="hidden" name="lpId" value="-1" />
				<input type="hidden" name="subId" value="100" />

				<input type="hidden" name="kw" value="" />
				<input type="hidden" name="cr" value="" />

				<input type="hidden" name="searchstr" value="" />
				<input type="hidden" name="lpurl" value="http://info.puppetlabs.com/testsubscription.html?cr={creative}&kw={keyword}"; />
				<input type="hidden" name="formid" value="1013" />
				<input type="hidden" name="returnURL" value="http://www.puppetlabs.com/misc/subscription-thank-you/"; />
				<input type="hidden" name="retURL" value="http://www.puppetlabs.com/misc/subscription-thank-you/"; />
				<input type="hidden" name="_mkt_disp" value="return" />
				<input type="hidden" name="_mkt_trk" value="" />

				</form>
				<script type="text/javascript" src="http://info.puppetlabs.com/js/mktFormSupport.js"></script>

				<script type="text/javascript">
				function formSubmit(elt) {
				return Mkto.formSubmit(elt);
				}
				function formReset(elt) {
				return Mkto.formReset(elt);
				}
				</script>

<a href="http://info.puppetlabs.com/puppet-enterprise" class="fbtn">Try Puppet Enterprise FREE</a>

            </section>
            <section id="elsewhere">
              <h4>Get Involved</h4>
              <ul>

                <li class="chat"><a href="http://webchat.freenode.net/?channels=puppet" rel="external"><span class="indicator"></span><span>Chat with us on IRC</span></a></li>
		<li class="discussion"><a href="http://groups.google.com/group/puppet-dev" rel="external"><span class="indicator"></span><span>Join the Puppet Developer List</span></a></li>
                <li class="discussion"><a href="http://groups.google.com/group/puppet-users?pli=1" rel="external"><span class="indicator"></span><span>Join the Puppet User List</span></a></li>

                <li class="linkedin"><a href="http://www.linkedin.com/groups?about=&gid=696467&trk=anet_ug_grppro" rel="external"><span class="indicator"></span><span>Join the Puppet Users LinkedIn group</span></a></li>

              </ul>
		<p>
		              		<h4>Follow us&#8230;</h4>

              		<ul class="followus">


			<li><a href="http://feeds.feedburner.com/PuppetLabs" target="_blank"><img src="http://www.puppetlabs.com/wp-content/plugins/my-profiles/images/rss.png" border="0"></a></li>
			<li><a href="http://www.facebook.com/pages/Puppet-Labs/219089920711" target="_blank"><img src="http://www.puppetlabs.com//wp-content/plugins/my-profiles/images/facebook.png" border="0"></a></li>
			<li><a href="http://www.twitter.com/puppetlabs" target="_blank"><img src="http://www.puppetlabs.com//wp-content/plugins/my-profiles/images/twitter.png" border="0"></a></li>
			<li><a href="http://www.linkedin.com/groups?about=&amp;gid=696467&amp;trk=anet_ug_grppro" target="_blank"><img src="http://www.puppetlabs.com//wp-content/uploads/2011/01/LinkedIn_IN_Icon_32px.png" border="0"></a></li>    <li><a href="https://github.com/puppetlabs" target="_blank"><img src="http://www.puppetlabs.com//wp-content/uploads/2011/01/github_icon.png" border="0"></a></li>
			<li><a href="https://plus.google.com/112682055028218091774?rel=author" target="_blank"><img src="https://puppetlabs.com/wp-content/uploads/2013/05/google_plus32x32.png" alt="Find Us on Google+" border="0"></a></li>
					</ul>

              	</p>

            </section>
          </div>
          <div class="secondary-content">
            <section id="book-it">
              <h4>Get the book!</h4>

              <p>James Turnbull and Jeff McCune's book <a href="http://www.apress.com/9781430230571" rel="nofollow">Pro Puppet</a> is a comprehensive and up-to-date look at Puppet and MCollective. </p>
              <a href="http://www.apress.com/9781430230571" rel="nofollow"><img src="http://www.puppetlabs.com/wp-content/uploads/2011/05/propuppetthumb.png" /></a>
            </section>
          </div>
        </div>
      </div>
		</footer>

    <div id="copyright">
      <div class="site-width">
        &copy; 2011 <a href="http://www.puppetlabs.com/" title="Puppet Labs">Puppet Labs</a>
        <span class="vcard">
         <span class="org"></span>
         <a class="email" href="mailto:info@puppetlabs.com">info@puppetlabs.com</a>

          <span class="adr">
           <span class="street-address">926 NW 13th Avenue #210</span>
           /
           <span class="locality">Portland</span>,
           <span class="region">OR</span>
           <span class="postal-code">97209</span>

          </span>

         <span class="tel">1-877-575-9775</span>
        </span>
      </div>
    </div>

  	<script type="text/javascript">Cufon.now();</script>
  	<style type="text/css">h1, h2, .btn { visibility : visible; }</style>


	</body>
</html>
